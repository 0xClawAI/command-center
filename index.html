<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>0xClaw Command Center</title>
<style>
:root {
  --bg: #0d1117; --surface: #161b22; --surface2: #1c2128;
  --border: #30363d; --border-light: #3d444d;
  --text: #e6edf3; --text-dim: #8b949e; --text-bright: #f0f6fc;
  --blue: #58a6ff; --green: #3fb950; --yellow: #d29922;
  --red: #f85149; --purple: #bc8cff; --cyan: #39d353; --orange: #f0883e;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ */
.topbar { display:flex; align-items:center; justify-content:space-between; padding:12px 24px; border-bottom:1px solid var(--border); background:var(--surface); }
.topbar h1 { font-size:16px; font-weight:700; }
.topbar h1 span { color:var(--blue); }
.topbar-right { display:flex; align-items:center; gap:16px; }
.agent-dots { display:flex; gap:6px; align-items:center; }
.agent-dot { position:relative; cursor:pointer; }
.agent-dot .dot { width:10px; height:10px; border-radius:50%; display:block; }
.agent-dot .dot.green { background:var(--green); }
.agent-dot .dot.yellow { background:var(--yellow); }
.agent-dot .dot.red { background:var(--red); }
.agent-dot .dot.unknown { background:var(--text-dim); }
.agent-dot .tip { display:none; position:absolute; top:18px; right:0; background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:8px 10px; font-size:11px; white-space:nowrap; z-index:100; min-width:160px; }
.agent-dot:hover .tip { display:block; }
.agent-dot .tip strong { color:var(--text-bright); }
.stat-pills { display:flex; gap:12px; font-size:12px; color:var(--text-dim); }
.stat-pills span { display:flex; align-items:center; gap:4px; }
.stat-pills .num { color:var(--text); font-weight:600; }
.meta-time { font-size:11px; color:var(--text-dim); }

/* ‚îÄ‚îÄ Issues Banner ‚îÄ‚îÄ */
.issues-banner { background:rgba(248,81,73,0.08); border-bottom:1px solid rgba(248,81,73,0.2); padding:8px 24px; font-size:12px; color:var(--red); display:none; }
.issues-banner.show { display:block; }
.issues-banner ul { list-style:none; display:flex; gap:20px; flex-wrap:wrap; }
.issues-banner li::before { content:'‚ö† '; }

/* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
.nav { display:flex; gap:0; border-bottom:1px solid var(--border); padding:0 24px; background:var(--surface); }
.nav button { background:none; border:none; color:var(--text-dim); padding:10px 16px; font-size:13px; cursor:pointer; border-bottom:2px solid transparent; font-weight:500; }
.nav button:hover { color:var(--text); }
.nav button.active { color:var(--blue); border-bottom-color:var(--blue); }

/* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
.panel { display:none; padding:20px 24px; overflow-y:auto; height:calc(100vh - 110px); }
.panel.active { display:block; }

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:12px; }
.card h3 { font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-dim); margin-bottom:10px; }
.card h2 { font-size:15px; font-weight:600; margin-bottom:8px; }

/* ‚îÄ‚îÄ Goal Header ‚îÄ‚îÄ */
.goal-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
.goal-header .goal-icon { font-size:24px; }
.goal-header .goal-text { flex:1; }
.goal-header .goal-text h2 { font-size:16px; margin:0; }
.goal-header .goal-text p { font-size:12px; color:var(--text-dim); margin:2px 0 0; }

/* ‚îÄ‚îÄ Metrics Row ‚îÄ‚îÄ */
.metrics { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-bottom:16px; }
.metric { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:12px; }
.metric .val { font-size:22px; font-weight:700; }
.metric .val.green { color:var(--green); }
.metric .val.blue { color:var(--blue); }
.metric .val.yellow { color:var(--yellow); }
.metric .val.red { color:var(--red); }
.metric .lbl { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.3px; margin-top:2px; }

/* ‚îÄ‚îÄ Two Column ‚îÄ‚îÄ */
.two-col { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media(max-width:900px) { .two-col { grid-template-columns:1fr; } }

/* ‚îÄ‚îÄ Activity List ‚îÄ‚îÄ */
.activity-list { max-height:400px; overflow-y:auto; }
.activity-item { padding:8px 0; border-bottom:1px solid rgba(48,54,61,0.5); font-size:12px; line-height:1.5; }
.activity-item .time { color:var(--blue); font-family:monospace; margin-right:6px; }
.activity-item:last-child { border-bottom:none; }

/* ‚îÄ‚îÄ Tweet Cards ‚îÄ‚îÄ */
.tweet-card { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:10px 12px; margin-bottom:8px; font-size:12px; }
.tweet-card .tweet-header { display:flex; justify-content:space-between; margin-bottom:4px; }
.tweet-card .tweet-header .type { color:var(--purple); font-size:10px; text-transform:uppercase; }
.tweet-card .tweet-header .time { color:var(--text-dim); font-size:10px; }
.tweet-card .tweet-text { line-height:1.4; }
.tweet-card .tweet-url { color:var(--blue); font-size:10px; text-decoration:none; margin-top:4px; display:inline-block; }
.tweet-card .tweet-context { color:var(--text-dim); font-size:11px; margin-top:4px; font-style:italic; }

/* ‚îÄ‚îÄ Conversation Cards ‚îÄ‚îÄ */
.conv-card { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:10px 12px; margin-bottom:8px; }
.conv-card .conv-title { font-size:13px; font-weight:600; margin-bottom:4px; }
.conv-card .conv-detail { font-size:11px; color:var(--text-dim); line-height:1.5; }
.conv-card .conv-status { font-size:10px; margin-top:4px; }
.conv-card .conv-status.good { color:var(--green); }

/* ‚îÄ‚îÄ Project Cards ‚îÄ‚îÄ */
.project-row { display:flex; align-items:center; gap:12px; padding:10px 12px; border-bottom:1px solid var(--border); font-size:13px; cursor:pointer; }
.project-row:hover { background:rgba(88,166,255,0.05); }
.project-row:last-child { border-bottom:none; }
.project-row .proj-name { flex:1; font-weight:500; }
.project-row .proj-status { font-size:10px; padding:2px 8px; border-radius:10px; }
.project-row .proj-status.active { background:rgba(88,166,255,0.15); color:var(--blue); }
.project-row .proj-status.complete { background:rgba(63,185,80,0.15); color:var(--green); }
.project-row .proj-status.paused { background:rgba(210,153,34,0.15); color:var(--yellow); }
.proj-bar { width:80px; height:5px; background:var(--border); border-radius:3px; overflow:hidden; }
.proj-bar-fill { height:100%; background:var(--green); border-radius:3px; }
.proj-pct { font-size:11px; color:var(--text-dim); width:35px; text-align:right; }

/* ‚îÄ‚îÄ Project Detail Modal ‚îÄ‚îÄ */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; }
.modal-overlay.show { display:flex; align-items:center; justify-content:center; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:10px; width:90%; max-width:800px; max-height:80vh; overflow-y:auto; padding:24px; }
.modal h2 { font-size:16px; margin-bottom:12px; }
.modal .close-btn { float:right; background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:18px; }
.modal .task-row { display:flex; align-items:center; gap:8px; padding:6px 0; font-size:12px; border-bottom:1px solid rgba(48,54,61,0.3); }
.task-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.task-dot.done { background:var(--green); }
.task-dot.in_progress { background:var(--blue); }
.task-dot.failed { background:var(--red); }
.task-dot.todo { background:var(--text-dim); }
.task-dot.testing { background:var(--yellow); }
.task-dot.blocked { background:var(--purple); }
.task-id { color:var(--text-dim); font-family:monospace; font-size:10px; min-width:40px; }
.task-title { flex:1; }

/* ‚îÄ‚îÄ Research Cards ‚îÄ‚îÄ */
.finding-card { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:12px; margin-bottom:8px; }
.finding-card h4 { font-size:13px; margin-bottom:4px; }
.finding-card .finding-meta { font-size:11px; color:var(--text-dim); }

/* ‚îÄ‚îÄ Cost Tracking ‚îÄ‚îÄ */
.cost-note { color:var(--text-dim); font-size:12px; font-style:italic; padding:8px 0; }

/* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
.empty { color:var(--text-dim); font-style:italic; font-size:12px; padding:12px 0; }

/* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <h1>üêæ <span>0xClaw</span> Command Center</h1>
  <div class="topbar-right">
    <div class="agent-dots" id="agentDots"></div>
    <div class="stat-pills" id="statPills"></div>
    <div class="meta-time" id="metaTime"></div>
  </div>
</div>

<!-- Issues Banner -->
<div class="issues-banner" id="issuesBanner"><ul id="issuesList"></ul></div>

<!-- Nav -->
<div class="nav" id="nav">
  <button class="active" data-panel="overview">Overview</button>
  <button data-panel="content">üìù Content</button>
  <button data-panel="engineering">‚öôÔ∏è Engineering</button>
  <button data-panel="research">üî¨ Research</button>
  <button data-panel="comms">üì° Comms</button>
</div>

<!-- Overview Panel -->
<div class="panel active" id="panel-overview">
  <div class="two-col">
    <div>
      <div class="card">
        <h3>Agent Status</h3>
        <div id="agentTable"></div>
      </div>
      <div class="card">
        <h3>Key Issues</h3>
        <div id="keyIssues"></div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3>Recent Activity (All Departments)</h3>
        <div class="activity-list" id="overviewActivity"></div>
      </div>
    </div>
  </div>
</div>

<!-- Content Panel -->
<div class="panel" id="panel-content">
  <div class="goal-header">
    <div class="goal-icon">üìù</div>
    <div class="goal-text">
      <h2>Content Department</h2>
      <p>Goal: Grow @0xClawAgent to 100+ engaged followers in 30 days</p>
    </div>
  </div>
  <div class="metrics" id="contentMetrics"></div>
  <div class="two-col">
    <div>
      <div class="card">
        <h3>Active Conversations</h3>
        <div id="conversations"></div>
      </div>
      <div class="card">
        <h3>Activity Feed</h3>
        <div class="activity-list" id="contentFeed"></div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3>Recent Posts</h3>
        <div id="recentPosts"></div>
      </div>
    </div>
  </div>
</div>

<!-- Engineering Panel -->
<div class="panel" id="panel-engineering">
  <div class="goal-header">
    <div class="goal-icon">‚öôÔ∏è</div>
    <div class="goal-text">
      <h2>Engineering Department</h2>
      <p>Goal: Ship working products autonomously</p>
    </div>
  </div>
  <div class="metrics" id="engMetrics"></div>
  <div class="two-col">
    <div>
      <div class="card">
        <h3>Projects</h3>
        <div id="projectList"></div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3>Activity Feed</h3>
        <div class="activity-list" id="engFeed"></div>
      </div>
    </div>
  </div>
</div>

<!-- Research Panel -->
<div class="panel" id="panel-research">
  <div class="goal-header">
    <div class="goal-icon">üî¨</div>
    <div class="goal-text">
      <h2>Research Department</h2>
      <p>Goal: Surface actionable intel that other agents use</p>
    </div>
  </div>
  <div class="metrics" id="researchMetrics"></div>
  <div class="two-col">
    <div>
      <div class="card">
        <h3>Findings</h3>
        <div id="findingsList"></div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3>Activity Feed</h3>
        <div class="activity-list" id="researchFeed"></div>
      </div>
    </div>
  </div>
</div>

<!-- Comms Panel -->
<div class="panel" id="panel-comms">
  <div class="goal-header">
    <div class="goal-icon">üì°</div>
    <div class="goal-text">
      <h2>Comms Department</h2>
      <p>Goal: Deadly never needs to ask "what's happening?"</p>
    </div>
  </div>
  <div class="metrics" id="commsMetrics"></div>
  <div class="card">
    <h3>Activity Feed</h3>
    <div class="activity-list" id="commsFeed"></div>
  </div>
</div>

<!-- Project Detail Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <button class="close-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">‚úï</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
let data = null;

// ‚îÄ‚îÄ Nav ‚îÄ‚îÄ
document.getElementById('nav').addEventListener('click', e => {
  if (e.target.tagName !== 'BUTTON') return;
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  e.target.classList.add('active');
  document.getElementById('panel-' + e.target.dataset.panel).classList.add('active');
});

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
function closeModal(e) {
  if (e.target === document.getElementById('modalOverlay'))
    document.getElementById('modalOverlay').classList.remove('show');
}

async function openProject(slug, name) {
  document.getElementById('modalOverlay').classList.add('show');
  document.getElementById('modalContent').innerHTML = '<p>Loading...</p>';
  try {
    const r = await fetch('/api/project/' + slug + '/state?' + Date.now());
    if (!r.ok) throw new Error('Not found');
    const state = await r.json();
    renderProjectModal(name, state);
  } catch(e) {
    document.getElementById('modalContent').innerHTML = '<p class="empty">Could not load project details</p>';
  }
}

function renderProjectModal(name, state) {
  const tasks = state.tasks || [];
  const milestones = state.milestones || [];
  
  // Summary stats
  const done = tasks.filter(t => t.status === 'done').length;
  const ip = tasks.filter(t => t.status === 'in_progress').length;
  const failed = tasks.filter(t => t.status === 'failed').length;
  
  let html = `<h2>${name}</h2>`;
  html += `<div style="margin-bottom:12px;font-size:12px;color:var(--text-dim)">
    ${done}/${tasks.length} done ¬∑ ${ip} in progress ¬∑ ${failed} failed
  </div>`;
  
  // Milestones with tasks
  for (const m of milestones) {
    const mTasks = tasks.filter(t => m.tasks && m.tasks.includes(t.id));
    const mDone = mTasks.filter(t => t.status === 'done').length;
    const pct = mTasks.length ? Math.round(mDone / mTasks.length * 100) : 0;
    html += `<div style="margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <strong style="font-size:13px">${m.name}</strong>
        <div style="flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:var(--green);border-radius:2px"></div>
        </div>
        <span style="font-size:11px;color:var(--text-dim)">${mDone}/${mTasks.length}</span>
      </div>`;
    for (const t of mTasks) {
      const sc = t.status === 'done' ? 'done' : t.status === 'in_progress' ? 'in_progress' : t.status === 'failed' ? 'failed' : 'todo';
      html += `<div class="task-row">
        <div class="task-dot ${sc}"></div>
        <span class="task-id">${t.id}</span>
        <span class="task-title">${t.title}</span>
      </div>`;
    }
    html += '</div>';
  }
  
  // Ungrouped tasks
  const grouped = new Set(milestones.flatMap(m => m.tasks || []));
  const ungrouped = tasks.filter(t => !grouped.has(t.id));
  if (ungrouped.length) {
    html += '<div style="margin-top:12px"><strong style="font-size:13px">Other Tasks</strong>';
    for (const t of ungrouped) {
      const sc = t.status === 'done' ? 'done' : t.status === 'in_progress' ? 'in_progress' : t.status === 'failed' ? 'failed' : 'todo';
      html += `<div class="task-row"><div class="task-dot ${sc}"></div><span class="task-id">${t.id}</span><span class="task-title">${t.title}</span></div>`;
    }
    html += '</div>';
  }
  
  document.getElementById('modalContent').innerHTML = html;
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function render() {
  if (!data) return;
  const o = data.overview;
  
  // Agent dots
  const dots = (o.agents || []).map(a => `
    <div class="agent-dot">
      <span class="dot ${a.status}"></span>
      <div class="tip"><strong>${a.name}</strong><br>${a.statusText || ''}<br><span style="color:var(--text-dim)">${a.lastAction || ''}</span>${a.issue ? `<br><span style="color:var(--yellow)">${a.issue}</span>` : ''}</div>
    </div>
  `).join('');
  document.getElementById('agentDots').innerHTML = dots;
  
  // Stat pills
  document.getElementById('statPills').innerHTML = `
    <span>üê¶ <span class="num">${o.todayTweets || 0}</span> tweets</span>
    <span>üì¶ <span class="num">${o.todayCommits || 0}</span> commits</span>
    <span>üî¨ <span class="num">${o.todayFindings || 0}</span> findings</span>
  `;
  
  // Time
  document.getElementById('metaTime').textContent = 'Updated ' + new Date(data.timestamp).toLocaleTimeString();
  
  // Issues banner
  const banner = document.getElementById('issuesBanner');
  if (o.issues && o.issues.length) {
    banner.classList.add('show');
    document.getElementById('issuesList').innerHTML = o.issues.map(i => `<li>${i}</li>`).join('');
  } else {
    banner.classList.remove('show');
  }
  
  // ‚îÄ‚îÄ Overview Panel ‚îÄ‚îÄ
  // Agent table
  document.getElementById('agentTable').innerHTML = (o.agents || []).length ? 
    `<table style="width:100%;font-size:12px;border-collapse:collapse">
      <tr style="color:var(--text-dim);text-align:left"><th style="padding:6px 8px">Dept</th><th style="padding:6px 8px">Status</th><th style="padding:6px 8px">Last Action</th><th style="padding:6px 8px">Issue</th></tr>
      ${o.agents.map(a => `<tr style="border-top:1px solid var(--border)">
        <td style="padding:6px 8px;font-weight:500">${a.name}</td>
        <td style="padding:6px 8px"><span class="dot ${a.status}" style="display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px;vertical-align:middle"></span>${a.statusText || ''}</td>
        <td style="padding:6px 8px;color:var(--text-dim)">${a.lastAction || ''}</td>
        <td style="padding:6px 8px;color:var(--yellow);font-size:11px">${a.issue || '‚Äî'}</td>
      </tr>`).join('')}
    </table>` : '<p class="empty">No health data</p>';
  
  // Key issues
  document.getElementById('keyIssues').innerHTML = (o.issues || []).length ?
    o.issues.map(i => `<div style="padding:6px 0;font-size:12px;border-bottom:1px solid var(--border)">‚ö†Ô∏è ${i}</div>`).join('') :
    '<p class="empty">No issues</p>';
  
  // Overview activity - merge all feeds
  const allFeeds = [
    ...(data.content.feed || []).map(f => ({...f, dept: 'üìù'})),
    ...(data.engineering.feed || []).map(f => ({...f, dept: '‚öôÔ∏è'})),
    ...(data.research.feed || []).map(f => ({...f, dept: 'üî¨'})),
    ...(data.comms.feed || []).map(f => ({...f, dept: 'üì°'})),
  ].sort((a, b) => (b.time || '').localeCompare(a.time || '')).slice(0, 30);
  
  document.getElementById('overviewActivity').innerHTML = allFeeds.length ?
    allFeeds.map(f => `<div class="activity-item">${f.dept} <span class="time">${f.time ? f.time.split(' ').pop() : ''}</span> ${f.message}</div>`).join('') :
    '<p class="empty">No recent activity in feeds</p>';
  
  // ‚îÄ‚îÄ Content Panel ‚îÄ‚îÄ
  const eng = data.content.engagement || {};
  const convs = eng.conversations || [];
  const posts = data.content.posts || [];
  
  document.getElementById('contentMetrics').innerHTML = `
    <div class="metric"><div class="val blue">${posts.length}</div><div class="lbl">Posts Today</div></div>
    <div class="metric"><div class="val green">${convs.filter(c => c.status && c.status.includes('GENUINE')).length}</div><div class="lbl">Real Conversations</div></div>
    <div class="metric"><div class="val">${convs.length}</div><div class="lbl">Engagements</div></div>
    <div class="metric"><div class="val blue">${eng.metrics?.totalImpressions || '‚Äî'}</div><div class="lbl">Impressions</div></div>
  `;
  
  // Conversations
  document.getElementById('conversations').innerHTML = convs.length ?
    convs.filter(c => c.topic || c.strategy).slice(0, 8).map(c => `
      <div class="conv-card">
        <div class="conv-title">${c.title}</div>
        <div class="conv-detail">${c.topic ? `<strong>Topic:</strong> ${c.topic}` : ''}${c.strategy ? `<br><strong>Strategy:</strong> ${c.strategy}` : ''}</div>
        ${c.status ? `<div class="conv-status ${c.status.includes('GENUINE') || c.status.includes('‚úÖ') ? 'good' : ''}">${c.status}</div>` : ''}
      </div>
    `).join('') : '<p class="empty">No active conversations</p>';
  
  // Content feed
  document.getElementById('contentFeed').innerHTML = (data.content.feed || []).length ?
    data.content.feed.map(f => `<div class="activity-item"><span class="time">${f.time ? f.time.split(' ').pop() : ''}</span> ${f.message}</div>`).join('') :
    '<p class="empty">No feed entries today</p>';
  
  // Recent posts
  document.getElementById('recentPosts').innerHTML = posts.length ?
    posts.slice(0, 10).map(p => `
      <div class="tweet-card">
        <div class="tweet-header">
          <span class="type">${p.context && p.context.includes('reply') ? 'Reply' : p.context && p.context.includes('Reply') ? 'Reply' : 'Original'}</span>
          <span class="time">${p.header || ''}</span>
        </div>
        <div class="tweet-text">${p.text || ''}</div>
        ${p.url ? `<a class="tweet-url" href="${p.url}" target="_blank">View ‚Üí</a>` : ''}
        ${p.context ? `<div class="tweet-context">${p.context}</div>` : ''}
      </div>
    `).join('') : '<p class="empty">No posts today</p>';
  
  // ‚îÄ‚îÄ Engineering Panel ‚îÄ‚îÄ
  const engData = data.engineering;
  document.getElementById('engMetrics').innerHTML = `
    <div class="metric"><div class="val green">${engData.doneTasks || 0}</div><div class="lbl">Tasks Done</div></div>
    <div class="metric"><div class="val blue">${engData.inProgress || 0}</div><div class="lbl">In Progress</div></div>
    <div class="metric"><div class="val">${engData.totalTasks || 0}</div><div class="lbl">Total Tasks</div></div>
    <div class="metric"><div class="val ${engData.failed > 0 ? 'red' : ''}">${engData.failed || 0}</div><div class="lbl">Failed</div></div>
    <div class="metric"><div class="val blue">${engData.commits || 0}</div><div class="lbl">Commits Today</div></div>
    <div class="metric"><div class="val">${(engData.projects || []).filter(p => p.status === 'active').length}</div><div class="lbl">Active Projects</div></div>
  `;
  
  // Project list ‚Äî grouped: active first, then paused, then complete
  const statusOrder = { active: 0, paused: 1, complete: 2 };
  const projs = (engData.projects || []).sort((a, b) => (statusOrder[a.status] ?? 9) - (statusOrder[b.status] ?? 9));
  document.getElementById('projectList').innerHTML = projs.length ?
    projs.map(p => {
      const pct = p.total ? Math.round((p.done || 0) / p.total * 100) : 0;
      return `<div class="project-row" onclick="openProject('${p.slug}','${(p.name||'').replace(/'/g,"\\'")}')">
        <span class="proj-name">${p.name}</span>
        <span class="proj-status ${p.status || 'unknown'}">${p.status || '?'}</span>
        ${p.total ? `<div class="proj-bar"><div class="proj-bar-fill" style="width:${pct}%"></div></div><span class="proj-pct">${pct}%</span>` : '<span class="proj-pct" style="color:var(--text-dim)">‚Äî</span>'}
      </div>`;
    }).join('') : '<p class="empty">No projects</p>';
  
  // Eng feed
  document.getElementById('engFeed').innerHTML = (engData.feed || []).length ?
    engData.feed.map(f => `<div class="activity-item"><span class="time">${f.time ? f.time.split(' ').pop() : ''}</span> ${f.message}</div>`).join('') :
    '<p class="empty">No feed entries today</p>';
  
  // ‚îÄ‚îÄ Research Panel ‚îÄ‚îÄ
  const resData = data.research;
  const findings = resData.findings || [];
  document.getElementById('researchMetrics').innerHTML = `
    <div class="metric"><div class="val blue">${findings.length}</div><div class="lbl">Findings</div></div>
    <div class="metric"><div class="val">${findings.reduce((s,f) => s + (f.sections||0), 0)}</div><div class="lbl">Total Sections</div></div>
  `;
  
  document.getElementById('findingsList').innerHTML = findings.length ?
    findings.map(f => `
      <div class="finding-card">
        <h4>${f.title}</h4>
        <div class="finding-meta">${f.date || 'No date'} ¬∑ ${f.sections} sections ¬∑ ${Math.round(f.size/1024)}KB</div>
      </div>
    `).join('') : '<p class="empty">No findings</p>';
  
  document.getElementById('researchFeed').innerHTML = (resData.feed || []).length ?
    resData.feed.map(f => `<div class="activity-item"><span class="time">${f.time ? f.time.split(' ').pop() : ''}</span> ${f.message}</div>`).join('') :
    '<p class="empty">No feed entries today</p>';
  
  // ‚îÄ‚îÄ Comms Panel ‚îÄ‚îÄ
  const commsData = data.comms;
  document.getElementById('commsMetrics').innerHTML = `
    <div class="metric"><div class="val blue">${(commsData.feed || []).length}</div><div class="lbl">Feed Entries Today</div></div>
  `;
  
  document.getElementById('commsFeed').innerHTML = (commsData.feed || []).length ?
    commsData.feed.map(f => `<div class="activity-item"><span class="time">${f.time ? f.time.split(' ').pop() : ''}</span> ${f.message}</div>`).join('') :
    '<p class="empty">No feed entries today</p>';
}

async function poll() {
  try {
    const r = await fetch('/api/dashboard?' + Date.now());
    if (r.ok) { data = await r.json(); render(); }
  } catch(e) { console.error('Poll failed:', e); }
}

poll();
setInterval(poll, 60000); // 60 second refresh
</script>
</body>
</html>
