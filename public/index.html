<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control — The Constellation</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Inter:wght@300;400;500;600;700&display=swap');

  :root {
    --bg: #0a0e1a;
    --bg-card: rgba(15, 20, 40, 0.85);
    --border: rgba(255,255,255,0.06);
    --text: #c8d0e0;
    --text-dim: #5a6480;
    --text-bright: #e8edf5;
    --ceo: #ffffff;
    --eng: #00d4ff;
    --content: #ff6b9d;
    --research: #a78bfa;
    --comms: #34d399;
    --qa: #f59e0b;
    --error: #ef4444;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, sans-serif;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    cursor: grab;
  }
  body.dragging { cursor: grabbing; }

  /* Starfield + particle canvases */
  #starfield, #particles {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
  }
  #starfield { z-index: 0; }
  #particles { z-index: 2; }

  /* Main SVG layer */
  #constellation {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1;
  }

  /* HTML overlay layer */
  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 3; pointer-events: none;
  }
  #overlay > * { pointer-events: auto; }

  /* Top bar */
  #topbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 10;
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 24px;
    background: linear-gradient(180deg, rgba(10,14,26,0.95) 0%, rgba(10,14,26,0) 100%);
    pointer-events: none;
  }
  #topbar > * { pointer-events: auto; }
  .topbar-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px; font-weight: 500; letter-spacing: 2px;
    text-transform: uppercase; color: var(--text-dim);
  }
  .topbar-title span { color: var(--text-bright); }
  .topbar-status {
    display: flex; gap: 16px; font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
  }
  .status-pill {
    display: flex; align-items: center; gap: 6px;
    padding: 4px 10px; border-radius: 12px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
  }
  .status-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--comms); animation: pulse-dot 2s infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Detail panel (right side) */
  #detail-panel {
    position: fixed; top: 0; right: -480px; bottom: 0; width: 460px;
    z-index: 20;
    background: linear-gradient(135deg, rgba(12,16,30,0.97), rgba(8,12,24,0.99));
    border-left: 1px solid var(--border);
    backdrop-filter: blur(20px);
    transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    overflow-y: auto; padding: 24px;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.1) transparent;
  }
  #detail-panel.open { right: 0; }
  #detail-panel .panel-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 20px;
  }
  #detail-panel h2 {
    font-size: 18px; font-weight: 600; color: var(--text-bright);
  }
  .panel-close {
    background: none; border: none; color: var(--text-dim);
    font-size: 20px; cursor: pointer; padding: 4px 8px;
  }
  .panel-close:hover { color: var(--text-bright); }

  .panel-section {
    margin-bottom: 20px;
  }
  .panel-section h3 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; font-weight: 500; text-transform: uppercase;
    letter-spacing: 1.5px; color: var(--text-dim); margin-bottom: 10px;
  }

  .feed-item {
    display: flex; gap: 10px; padding: 8px 0;
    border-bottom: 1px solid var(--border); font-size: 13px;
  }
  .feed-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; color: var(--text-dim); white-space: nowrap; min-width: 42px;
  }
  .feed-text { color: var(--text); line-height: 1.4; }

  .inbox-item {
    padding: 10px 12px; margin-bottom: 8px;
    border-radius: 8px; background: rgba(255,255,255,0.03);
    border: 1px solid var(--border); font-size: 13px;
  }
  .inbox-item .inbox-title { color: var(--text-bright); font-weight: 500; }
  .inbox-item .inbox-meta { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

  .stat-row {
    display: flex; justify-content: space-between; padding: 6px 0;
    font-size: 13px; border-bottom: 1px solid var(--border);
  }
  .stat-label { color: var(--text-dim); }
  .stat-value { color: var(--text-bright); font-family: 'JetBrains Mono', monospace; font-weight: 500; }

  .project-card {
    padding: 12px; margin-bottom: 10px;
    border-radius: 8px; background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
  }
  .project-name { font-weight: 600; color: var(--text-bright); font-size: 14px; }
  .project-phase {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    color: var(--text-dim); text-transform: uppercase; margin-top: 4px;
  }
  .progress-bar {
    height: 4px; border-radius: 2px; background: rgba(255,255,255,0.06);
    margin-top: 8px; overflow: hidden;
  }
  .progress-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }

  .finding-item {
    padding: 10px 12px; margin-bottom: 8px;
    border-radius: 8px; background: rgba(255,255,255,0.03);
    border-left: 3px solid var(--research);
    font-size: 13px;
  }
  .finding-title { color: var(--text-bright); font-weight: 500; }
  .finding-route { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

  /* Service status list */
  .service-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px;
  }
  .service-status {
    width: 8px; height: 8px; border-radius: 50%;
  }
  .service-status.online { background: var(--comms); box-shadow: 0 0 6px var(--comms); }
  .service-status.stopped { background: var(--error); }
  .service-name { color: var(--text-bright); flex: 1; }
  .service-mem { font-family: 'JetBrains Mono', monospace; color: var(--text-dim); font-size: 11px; }

  /* Changelog panel (bottom) */
  #changelog {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 10;
    max-height: 0; overflow: hidden;
    background: linear-gradient(0deg, rgba(10,14,26,0.97) 0%, rgba(10,14,26,0.90) 80%, transparent 100%);
    transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    padding: 0 24px;
  }
  #changelog.open { max-height: 300px; padding: 16px 24px; }
  .changelog-header {
    display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
  }
  .changelog-header h3 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px;
    color: var(--text-dim);
  }
  .time-filters { display: flex; gap: 6px; }
  .time-filter {
    padding: 3px 10px; border-radius: 10px; font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    background: rgba(255,255,255,0.04); border: 1px solid var(--border);
    color: var(--text-dim); cursor: pointer; transition: all 0.2s;
  }
  .time-filter:hover, .time-filter.active {
    background: rgba(255,255,255,0.1); color: var(--text-bright);
  }
  .changelog-entries {
    display: flex; flex-direction: column; gap: 4px;
    max-height: 220px; overflow-y: auto;
    scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.1) transparent;
  }
  .changelog-entry {
    display: flex; align-items: center; gap: 10px;
    padding: 5px 0; font-size: 12px;
  }
  .changelog-agent {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; padding: 2px 8px; border-radius: 8px;
    min-width: 70px; text-align: center;
    background: rgba(255,255,255,0.04);
  }

  /* Minimap */
  #minimap {
    position: fixed; bottom: 16px; right: 16px; z-index: 10;
    width: 140px; height: 100px;
    background: rgba(10,14,26,0.8);
    border: 1px solid var(--border); border-radius: 8px;
    overflow: hidden;
  }
  #minimap canvas { width: 100%; height: 100%; }

  /* Search */
  #search-container {
    position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
    z-index: 30; display: none;
  }
  #search-container.open { display: block; }
  #search-input {
    width: 400px; padding: 12px 20px;
    background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; color: var(--text-bright);
    font-family: 'Inter', sans-serif; font-size: 14px;
    outline: none;
  }
  #search-input:focus { border-color: rgba(255,255,255,0.2); }
  #search-input::placeholder { color: var(--text-dim); }

  /* Bottom controls */
  #controls {
    position: fixed; bottom: 16px; left: 16px; z-index: 10;
    display: flex; gap: 8px;
  }
  .ctrl-btn {
    padding: 6px 14px; border-radius: 8px; font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    background: rgba(255,255,255,0.04); border: 1px solid var(--border);
    color: var(--text-dim); cursor: pointer; transition: all 0.2s;
  }
  .ctrl-btn:hover { background: rgba(255,255,255,0.08); color: var(--text-bright); }
  .ctrl-btn.active { background: rgba(255,255,255,0.1); color: var(--text-bright); }

  /* Tooltips */
  .tooltip {
    position: absolute; pointer-events: none; z-index: 25;
    padding: 10px 14px; border-radius: 10px;
    background: rgba(12,16,30,0.95); border: 1px solid var(--border);
    backdrop-filter: blur(12px);
    font-size: 12px; max-width: 280px;
    opacity: 0; transition: opacity 0.15s;
  }
  .tooltip.visible { opacity: 1; }
  .tooltip-title { font-weight: 600; color: var(--text-bright); margin-bottom: 4px; }
  .tooltip-stat { color: var(--text-dim); }
  .tooltip-stat span { color: var(--text); }

  /* Blocked items warning */
  .blocked-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 2px 8px; border-radius: 8px;
    background: rgba(239,68,68,0.15); color: var(--error);
    font-size: 11px; font-family: 'JetBrains Mono', monospace;
    animation: pulse-blocked 2s infinite;
  }
  @keyframes pulse-blocked {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  /* Keyboard hints */
  #keyhints {
    position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
    z-index: 10; display: flex; gap: 12px;
    font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-dim);
    opacity: 0.5;
  }
  kbd {
    padding: 1px 6px; border-radius: 4px;
    background: rgba(255,255,255,0.06); border: 1px solid var(--border);
  }
</style>
</head>
<body>
<!-- Top bar -->
<div id="topbar">
  <div class="topbar-title">
    <span>Mission Control</span> · The Constellation
  </div>
  <div class="topbar-status">
    <div class="status-pill">
      <div class="status-dot"></div>
      <span id="status-services">—</span>
    </div>
    <div class="status-pill" id="status-agents">—</div>
    <div class="status-pill" id="status-inbox">—</div>
    <div class="status-pill" id="blocked-pill" style="display:none">
      <span class="blocked-badge">⚠ <span id="blocked-count">0</span> blocked</span>
    </div>
  </div>
</div>

<!-- Canvases -->
<canvas id="starfield"></canvas>
<svg id="constellation"></svg>
<canvas id="particles"></canvas>

<!-- HTML overlay -->
<div id="overlay">
  <div class="tooltip" id="tooltip"></div>
</div>

<!-- Detail panel -->
<div id="detail-panel">
  <div class="panel-header">
    <h2 id="panel-title">—</h2>
    <button class="panel-close" onclick="closePanel()">✕</button>
  </div>
  <div id="panel-content"></div>
</div>

<!-- Changelog -->
<div id="changelog">
  <div class="changelog-header">
    <h3>Activity Log</h3>
    <div class="time-filters">
      <button class="time-filter active" data-since="1h">1h</button>
      <button class="time-filter" data-since="4h">4h</button>
      <button class="time-filter" data-since="12h">12h</button>
      <button class="time-filter" data-since="1d">1d</button>
    </div>
  </div>
  <div class="changelog-entries" id="changelog-entries"></div>
</div>

<!-- Search -->
<div id="search-container">
  <input id="search-input" type="text" placeholder="Search agents, projects, tasks…" autofocus>
</div>

<!-- Bottom controls -->
<div id="controls">
  <button class="ctrl-btn" onclick="resetView()">Reset View</button>
  <button class="ctrl-btn" id="btn-changelog" onclick="toggleChangelog()">Activity Log</button>
  <button class="ctrl-btn" id="btn-pause" onclick="togglePause()">⏸ Pause</button>
</div>

<!-- Keyboard hints -->
<div id="keyhints">
  <span><kbd>Esc</kbd> Overview</span>
  <span><kbd>1-6</kbd> Jump</span>
  <span><kbd>/</kbd> Search</span>
  <span><kbd>Space</kbd> Pause</span>
  <span><kbd>L</kbd> Log</span>
</div>

<script type="module">
import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';

// ─── State ─────────────────────────────────────────────────
const W = window.innerWidth, H = window.innerHeight;
let paused = false;
let currentZoom = d3.zoomIdentity;
let focusedNode = null;
let data = { agents: [], health: null, projects: [], changelog: [], blocked: [], metrics: null, research: null };

const DEPT_ORDER = ['ceo', 'engineering', 'content', 'research', 'comms', 'qa'];
const COLORS = { ceo:'#ffffff', engineering:'#00d4ff', content:'#ff6b9d', research:'#a78bfa', comms:'#34d399', qa:'#f59e0b' };
const LABELS = { ceo:'CEO', engineering:'Engineering', content:'Content', research:'Research', comms:'Comms', qa:'QA' };

// ─── Starfield Background ──────────────────────────────────
const starCanvas = document.getElementById('starfield');
const starCtx = starCanvas.getContext('2d');
starCanvas.width = W * devicePixelRatio;
starCanvas.height = H * devicePixelRatio;
starCtx.scale(devicePixelRatio, devicePixelRatio);

const stars = Array.from({ length: 200 }, () => ({
  x: Math.random() * W,
  y: Math.random() * H,
  r: Math.random() * 1.2 + 0.2,
  a: Math.random() * 0.5 + 0.1,
  speed: Math.random() * 0.005 + 0.002,
  phase: Math.random() * Math.PI * 2,
}));

function drawStars(t) {
  starCtx.clearRect(0, 0, W, H);
  // Subtle grid dots
  const gridSpacing = 60;
  starCtx.fillStyle = 'rgba(26,31,54,0.4)';
  for (let x = 0; x < W; x += gridSpacing) {
    for (let y = 0; y < H; y += gridSpacing) {
      starCtx.beginPath();
      starCtx.arc(x, y, 0.5, 0, Math.PI * 2);
      starCtx.fill();
    }
  }
  // Stars
  for (const s of stars) {
    const alpha = s.a + Math.sin(t * s.speed + s.phase) * 0.2;
    starCtx.fillStyle = `rgba(200,210,230,${Math.max(0, alpha)})`;
    starCtx.beginPath();
    starCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    starCtx.fill();
  }
}

// ─── Particle System ───────────────────────────────────────
const partCanvas = document.getElementById('particles');
const partCtx = partCanvas.getContext('2d');
partCanvas.width = W * devicePixelRatio;
partCanvas.height = H * devicePixelRatio;
partCtx.scale(devicePixelRatio, devicePixelRatio);

class Particle {
  constructor(edge) {
    this.edge = edge;
    this.t = Math.random();
    this.speed = 0.002 + Math.random() * 0.003;
    this.size = 1 + Math.random() * 1.5;
    this.alpha = 0.3 + Math.random() * 0.5;
  }
  update() {
    this.t += this.speed;
    if (this.t > 1) this.t = 0;
  }
}

let particles = [];
function initParticles(edges) {
  particles = [];
  for (const edge of edges) {
    const count = edge.intensity || 3;
    for (let i = 0; i < count; i++) {
      particles.push(new Particle(edge));
    }
  }
}

function drawParticles() {
  partCtx.clearRect(0, 0, W, H);
  if (paused) return;
  
  const t = currentZoom;
  for (const p of particles) {
    p.update();
    const src = p.edge.source;
    const tgt = p.edge.target;
    if (!src.x || !tgt.x) continue;
    
    // Interpolate along edge with curve
    const mx = (src.x + tgt.x) / 2 + (src.y - tgt.y) * 0.15;
    const my = (src.y + tgt.y) / 2 + (tgt.x - src.x) * 0.15;
    const tt = p.t;
    const u = 1 - tt;
    const px = u*u*src.x + 2*u*tt*mx + tt*tt*tgt.x;
    const py = u*u*src.y + 2*u*tt*my + tt*tt*tgt.y;
    
    // Apply zoom transform
    const sx = px * currentZoom.k + currentZoom.x;
    const sy = py * currentZoom.k + currentZoom.y;
    
    // Color gradient from source to target
    const srcColor = d3.color(COLORS[src.id] || '#ffffff');
    const tgtColor = d3.color(COLORS[tgt.id] || '#ffffff');
    const r = Math.round(srcColor.r * (1 - tt) + tgtColor.r * tt);
    const g = Math.round(srcColor.g * (1 - tt) + tgtColor.g * tt);
    const b = Math.round(srcColor.b * (1 - tt) + tgtColor.b * tt);

    partCtx.beginPath();
    partCtx.arc(sx, sy, p.size * currentZoom.k, 0, Math.PI * 2);
    partCtx.fillStyle = `rgba(${r},${g},${b},${p.alpha})`;
    partCtx.fill();
    
    // Glow
    partCtx.beginPath();
    partCtx.arc(sx, sy, p.size * 3 * currentZoom.k, 0, Math.PI * 2);
    partCtx.fillStyle = `rgba(${r},${g},${b},${p.alpha * 0.15})`;
    partCtx.fill();
  }
}

// ─── D3 Constellation ──────────────────────────────────────
const svg = d3.select('#constellation').attr('width', W).attr('height', H);

// Glow filters
const defs = svg.append('defs');
for (const [name, color] of Object.entries(COLORS)) {
  const f = defs.append('filter').attr('id', `glow-${name}`).attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
  f.append('feGaussianBlur').attr('stdDeviation', 6).attr('result', 'blur');
  f.append('feFlood').attr('flood-color', color).attr('flood-opacity', 0.4).attr('result', 'color');
  f.append('feComposite').attr('in', 'color').attr('in2', 'blur').attr('operator', 'in').attr('result', 'glow');
  const merge = f.append('feMerge');
  merge.append('feMergeNode').attr('in', 'glow');
  merge.append('feMergeNode').attr('in', 'SourceGraphic');
}
// Soft glow for edges
const edgeFilter = defs.append('filter').attr('id', 'edge-glow').attr('x', '-20%').attr('y', '-20%').attr('width', '140%').attr('height', '140%');
edgeFilter.append('feGaussianBlur').attr('stdDeviation', 2);

const g = svg.append('g');

// Build graph data
const positions = {
  ceo: { x: W/2, y: H/2 },
  engineering: { x: W/2 - 280, y: H/2 - 180 },
  content: { x: W/2 + 280, y: H/2 - 160 },
  research: { x: W/2, y: H/2 - 280 },
  comms: { x: W/2 + 220, y: H/2 + 200 },
  qa: { x: W/2 - 220, y: H/2 + 200 },
};

const nodes = DEPT_ORDER.map(id => ({
  id,
  label: LABELS[id],
  color: COLORS[id],
  r: id === 'ceo' ? 36 : (id === 'comms' || id === 'qa') ? 22 : 28,
  x: positions[id].x,
  y: positions[id].y,
  fx: null, fy: null,
  // data fields populated on fetch
  feedCount: 0, inboxPending: 0, status: 'idle',
}));

const edges = [
  { source: 'ceo', target: 'engineering', intensity: 5 },
  { source: 'ceo', target: 'content', intensity: 4 },
  { source: 'ceo', target: 'research', intensity: 4 },
  { source: 'research', target: 'content', intensity: 3 },
  { source: 'research', target: 'engineering', intensity: 3 },
  { source: 'qa', target: 'engineering', intensity: 2 },
  { source: 'qa', target: 'content', intensity: 2 },
  { source: 'qa', target: 'research', intensity: 2 },
  { source: 'comms', target: 'ceo', intensity: 3 },
  { source: 'comms', target: 'content', intensity: 2 },
];

// Force simulation
const sim = d3.forceSimulation(nodes)
  .force('link', d3.forceLink(edges).id(d => d.id).distance(200).strength(0.3))
  .force('charge', d3.forceManyBody().strength(-600))
  .force('center', d3.forceCenter(W/2, H/2).strength(0.05))
  .force('x', d3.forceX(d => positions[d.id].x).strength(0.08))
  .force('y', d3.forceY(d => positions[d.id].y).strength(0.08))
  .alphaDecay(0.02)
  .velocityDecay(0.4);

// Draw edges
const edgeSelection = g.selectAll('.edge').data(edges).join('path')
  .attr('class', 'edge')
  .attr('fill', 'none')
  .attr('stroke', d => {
    const sc = d3.color(COLORS[d.source.id || d.source]);
    const tc = d3.color(COLORS[d.target.id || d.target]);
    return sc ? `rgba(${sc.r},${sc.g},${sc.b},0.15)` : 'rgba(255,255,255,0.05)';
  })
  .attr('stroke-width', d => 1 + (d.intensity || 1) * 0.3)
  .attr('filter', 'url(#edge-glow)')
  .style('cursor', 'pointer')
  .on('mouseover', onEdgeHover)
  .on('mouseout', hideTooltip)
  .on('click', onEdgeClick);

// Draw nodes
const nodeGroup = g.selectAll('.node-group').data(nodes).join('g')
  .attr('class', 'node-group')
  .style('cursor', 'pointer')
  .call(d3.drag().on('start', dragStart).on('drag', dragged).on('end', dragEnd))
  .on('mouseover', onNodeHover)
  .on('mouseout', hideTooltip)
  .on('click', onNodeClick);

// Pulse ring (liveness)
nodeGroup.append('circle')
  .attr('class', 'pulse-ring')
  .attr('r', d => d.r + 8)
  .attr('fill', 'none')
  .attr('stroke', d => d.color)
  .attr('stroke-width', 1.5)
  .attr('stroke-opacity', 0);

// Outer glow ring
nodeGroup.append('circle')
  .attr('class', 'glow-ring')
  .attr('r', d => d.r + 3)
  .attr('fill', 'none')
  .attr('stroke', d => d.color)
  .attr('stroke-width', 1)
  .attr('stroke-opacity', 0.2);

// Main node circle
nodeGroup.append('circle')
  .attr('class', 'node-circle')
  .attr('r', d => d.r)
  .attr('fill', d => {
    const c = d3.color(d.color);
    return `rgba(${c.r},${c.g},${c.b},0.12)`;
  })
  .attr('stroke', d => d.color)
  .attr('stroke-width', 1.5)
  .attr('filter', d => `url(#glow-${d.id})`);

// Inner fill indicator (shows activity level)
nodeGroup.append('circle')
  .attr('class', 'activity-fill')
  .attr('r', 0)
  .attr('fill', d => d.color)
  .attr('opacity', 0.15);

// Label
nodeGroup.append('text')
  .attr('class', 'node-label')
  .text(d => d.label)
  .attr('text-anchor', 'middle')
  .attr('dy', d => d.r + 20)
  .attr('fill', d => d.color)
  .attr('font-family', 'JetBrains Mono, monospace')
  .attr('font-size', 11)
  .attr('font-weight', 500)
  .attr('letter-spacing', '0.5px')
  .attr('opacity', 0.8);

// Status text (below label)
nodeGroup.append('text')
  .attr('class', 'node-status')
  .text('')
  .attr('text-anchor', 'middle')
  .attr('dy', d => d.r + 34)
  .attr('fill', '#5a6480')
  .attr('font-family', 'JetBrains Mono, monospace')
  .attr('font-size', 9);

// Inbox badge
nodeGroup.append('g')
  .attr('class', 'inbox-badge')
  .attr('transform', d => `translate(${d.r * 0.7}, ${-d.r * 0.7})`)
  .each(function(d) {
    d3.select(this).append('circle').attr('r', 8).attr('fill', '#ef4444').attr('opacity', 0);
    d3.select(this).append('text').attr('text-anchor', 'middle').attr('dy', 3.5)
      .attr('font-size', 9).attr('font-weight', 600).attr('fill', '#fff').text('');
  });

// Sparkline group (QA trend)
nodeGroup.append('g')
  .attr('class', 'sparkline')
  .attr('transform', d => `translate(${-15}, ${-d.r - 16})`);

// Simulation tick
sim.on('tick', () => {
  edgeSelection.attr('d', d => {
    const mx = (d.source.x + d.target.x) / 2 + (d.source.y - d.target.y) * 0.15;
    const my = (d.source.y + d.target.y) / 2 + (d.target.x - d.source.x) * 0.15;
    return `M${d.source.x},${d.source.y} Q${mx},${my} ${d.target.x},${d.target.y}`;
  });
  nodeGroup.attr('transform', d => `translate(${d.x},${d.y})`);
});

// Zoom
const zoom = d3.zoom()
  .scaleExtent([0.3, 6])
  .on('zoom', (e) => {
    currentZoom = e.transform;
    g.attr('transform', e.transform);
  });
svg.call(zoom);

// ─── Animation Loop ────────────────────────────────────────
let animFrame = 0;
function animate(timestamp) {
  animFrame = requestAnimationFrame(animate);
  drawStars(timestamp * 0.001);
  drawParticles();
  
  // Pulse ring animation
  if (!paused) {
    nodeGroup.selectAll('.pulse-ring')
      .attr('stroke-opacity', d => {
        if (d.status !== 'active') return 0;
        const t = (timestamp * 0.001) % 3;
        return t < 1.5 ? Math.sin(t / 1.5 * Math.PI) * 0.4 : 0;
      })
      .attr('r', d => {
        if (d.status !== 'active') return d.r + 8;
        const t = (timestamp * 0.001) % 3;
        return d.r + 8 + (t < 1.5 ? t / 1.5 * 12 : 0);
      });
  }
}
animate(0);

// Initialize particles
initParticles(edges);

// ─── Interactions ──────────────────────────────────────────
function dragStart(event, d) {
  if (!event.active) sim.alphaTarget(0.15).restart();
  d.fx = d.x; d.fy = d.y;
  document.body.classList.add('dragging');
}
function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
function dragEnd(event, d) {
  if (!event.active) sim.alphaTarget(0);
  d.fx = null; d.fy = null;
  document.body.classList.remove('dragging');
}

const tooltip = document.getElementById('tooltip');
function showTooltip(x, y, html) {
  tooltip.innerHTML = html;
  tooltip.style.left = (x + 16) + 'px';
  tooltip.style.top = (y - 10) + 'px';
  tooltip.classList.add('visible');
}
function hideTooltip() {
  tooltip.classList.remove('visible');
}

function onNodeHover(event, d) {
  const agent = data.agents.find(a => a.name === d.id);
  if (!agent) return;
  const html = `
    <div class="tooltip-title" style="color:${d.color}">${d.label}</div>
    <div class="tooltip-stat">Status: <span>${d.status}</span></div>
    <div class="tooltip-stat">Feed entries: <span>${agent.feed?.length || 0}</span></div>
    <div class="tooltip-stat">Inbox pending: <span>${agent.inbox?.pending || 0}</span></div>
    ${agent.lastActivity ? `<div class="tooltip-stat">Last: <span>${agent.lastActivity.text?.substring(0, 60) || '—'}…</span></div>` : ''}
  `;
  showTooltip(event.clientX, event.clientY, html);
}

function onEdgeHover(event, d) {
  const src = typeof d.source === 'string' ? d.source : d.source.id;
  const tgt = typeof d.target === 'string' ? d.target : d.target.id;
  showTooltip(event.clientX, event.clientY, `
    <div class="tooltip-title">${LABELS[src]} → ${LABELS[tgt]}</div>
    <div class="tooltip-stat">Data flow connection</div>
  `);
}

function onEdgeClick(event, d) {
  // Could show flow details
}

function onNodeClick(event, d) {
  event.stopPropagation();
  focusedNode = d;
  
  // Smooth zoom to node
  const scale = 2.5;
  svg.transition().duration(750).call(
    zoom.transform,
    d3.zoomIdentity.translate(W/2 - d.x * scale, H/2 - d.y * scale).scale(scale)
  );
  
  openPanel(d);
}

svg.on('click', () => {
  if (focusedNode) {
    focusedNode = null;
    closePanel();
    resetView();
  }
});

// ─── Panel ─────────────────────────────────────────────────
function openPanel(d) {
  const panel = document.getElementById('detail-panel');
  const title = document.getElementById('panel-title');
  const content = document.getElementById('panel-content');
  
  title.style.color = d.color;
  title.textContent = d.label;
  
  const agent = data.agents.find(a => a.name === d.id);
  let html = '';
  
  if (d.id === 'ceo') {
    html = renderCEOPanel(agent);
  } else if (d.id === 'engineering') {
    html = renderEngineeringPanel(agent);
  } else if (d.id === 'content') {
    html = renderContentPanel(agent);
  } else if (d.id === 'research') {
    html = renderResearchPanel(agent);
  } else if (d.id === 'comms') {
    html = renderCommsPanel(agent);
  } else if (d.id === 'qa') {
    html = renderQAPanel(agent);
  }
  
  content.innerHTML = html;
  panel.classList.add('open');
}

function closePanel() {
  document.getElementById('detail-panel').classList.remove('open');
}

function renderCEOPanel(agent) {
  const health = data.health;
  const onlineCount = health?.summary?.online || 0;
  const totalCount = health?.summary?.total || 0;
  const metrics = data.metrics;
  
  let servicesHtml = '';
  if (health?.services) {
    servicesHtml = health.services.map(s => `
      <div class="service-item">
        <div class="service-status ${s.status}"></div>
        <span class="service-name">${s.name}</span>
        <span class="service-mem">${s.memory}MB</span>
      </div>
    `).join('');
  }
  
  let projectsHtml = '';
  if (data.projects?.length) {
    projectsHtml = data.projects.map(p => `
      <div class="project-card">
        <div class="project-name">${p.name}</div>
        <div class="project-phase">Phase: ${p.phase} · ${p.progress}%</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${p.progress}%;background:var(--eng)"></div>
        </div>
      </div>
    `).join('');
  }
  
  let blockedHtml = '';
  if (data.blocked?.length) {
    blockedHtml = data.blocked.map(b => `
      <div class="inbox-item" style="border-left:3px solid var(--error)">
        <div class="inbox-title">${b.title || b.text || '—'}</div>
        <div class="inbox-meta">${b.agent} · ${b.priority || 'from feed'}</div>
      </div>
    `).join('');
  }
  
  return `
    <div class="panel-section">
      <h3>System Health</h3>
      <div class="stat-row"><span class="stat-label">Services</span><span class="stat-value">${onlineCount}/${totalCount} online</span></div>
      ${servicesHtml}
    </div>
    <div class="panel-section">
      <h3>Active Projects</h3>
      ${projectsHtml || '<div style="color:var(--text-dim);font-size:13px">No active projects</div>'}
    </div>
    ${data.blocked?.length ? `<div class="panel-section"><h3>⚠ Blocked on Human</h3>${blockedHtml}</div>` : ''}
    <div class="panel-section">
      <h3>Metrics</h3>
      <div class="stat-row"><span class="stat-label">Git (today)</span><span class="stat-value">${metrics?.git?.commitsToday || 0} commits</span></div>
      <div class="stat-row"><span class="stat-label">Git (week)</span><span class="stat-value">${metrics?.git?.commitsWeek || 0} commits</span></div>
      <div class="stat-row"><span class="stat-label">Feed entries</span><span class="stat-value">${metrics?.feedEntries?.total || 0}</span></div>
      <div class="stat-row"><span class="stat-label">Inbox depth</span><span class="stat-value">${metrics?.inboxDepth?.total || 0} pending</span></div>
    </div>
    ${renderFeed(agent)}
  `;
}

function renderEngineeringPanel(agent) {
  let projectsHtml = '';
  if (data.projects?.length) {
    projectsHtml = data.projects.map(p => {
      const phaseIcon = { init: '○', prd: '△', build: '□', audit: '◇', smoke: '☆', complete: '★' }[p.phase] || '·';
      return `
        <div class="project-card">
          <div class="project-name">${phaseIcon} ${p.name}</div>
          <div class="project-phase">${p.phase.toUpperCase()} · ${p.doneTasks}/${p.totalTasks} tasks · ${p.progress}%</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${p.progress}%;background:var(--eng)"></div>
          </div>
          ${p.progressNote ? `<div style="font-size:11px;color:var(--text-dim);margin-top:6px">${p.progressNote}</div>` : ''}
        </div>
      `;
    }).join('');
  }
  
  return `
    <div class="panel-section">
      <h3>Active Builds</h3>
      ${projectsHtml || '<div style="color:var(--text-dim);font-size:13px">No projects found</div>'}
    </div>
    <div class="panel-section">
      <h3>Git Activity</h3>
      <div class="stat-row"><span class="stat-label">Commits today</span><span class="stat-value">${data.metrics?.git?.commitsToday || 0}</span></div>
      <div class="stat-row"><span class="stat-label">Commits this week</span><span class="stat-value">${data.metrics?.git?.commitsWeek || 0}</span></div>
    </div>
    ${renderInbox(agent)}
    ${renderFeed(agent)}
  `;
}

function renderContentPanel(agent) {
  return `
    <div class="panel-section">
      <h3>Content Activity</h3>
      <div class="stat-row"><span class="stat-label">Feed entries</span><span class="stat-value">${agent?.feed?.length || 0}</span></div>
      <div class="stat-row"><span class="stat-label">Inbox pending</span><span class="stat-value">${agent?.inbox?.pending || 0}</span></div>
    </div>
    ${renderInbox(agent)}
    ${renderFeed(agent)}
  `;
}

function renderResearchPanel(agent) {
  let findingsHtml = '';
  if (data.research?.findings?.length) {
    findingsHtml = data.research.findings.map(f => `
      <div class="finding-item">
        <div class="finding-title">${f.title}</div>
        <div class="finding-route">→ routed to ${f.routedTo}</div>
      </div>
    `).join('');
  }
  
  return `
    <div class="panel-section">
      <h3>Research Findings</h3>
      ${findingsHtml || '<div style="color:var(--text-dim);font-size:13px">No findings</div>'}
    </div>
    ${renderFeed(agent)}
  `;
}

function renderCommsPanel(agent) {
  return `
    <div class="panel-section">
      <h3>Comms Status</h3>
      <div class="stat-row"><span class="stat-label">Feed entries</span><span class="stat-value">${agent?.feed?.length || 0}</span></div>
      <div class="stat-row"><span class="stat-label">Last activity</span><span class="stat-value">${agent?.lastActivity?.time || '—'}</span></div>
    </div>
    ${renderFeed(agent)}
  `;
}

function renderQAPanel(agent) {
  return `
    <div class="panel-section">
      <h3>Quality Assurance</h3>
      <div class="stat-row"><span class="stat-label">Feed entries</span><span class="stat-value">${agent?.feed?.length || 0}</span></div>
    </div>
    ${renderFeed(agent)}
  `;
}

function renderFeed(agent) {
  if (!agent?.feed?.length) return '';
  const items = agent.feed.slice(0, 15).map(f => `
    <div class="feed-item">
      <span class="feed-time">${f.time}</span>
      <span class="feed-text">${f.text}</span>
    </div>
  `).join('');
  return `<div class="panel-section"><h3>Recent Activity</h3>${items}</div>`;
}

function renderInbox(agent) {
  if (!agent?.inbox?.items?.length) return '';
  const pending = agent.inbox.items.filter(i => !i.done);
  if (!pending.length) return '';
  const items = pending.slice(0, 5).map(i => `
    <div class="inbox-item">
      <div class="inbox-title">${i.title}</div>
      <div class="inbox-meta">${i.priority} · ${i.status}</div>
    </div>
  `).join('');
  return `<div class="panel-section"><h3>Inbox (${pending.length} pending)</h3>${items}</div>`;
}

// ─── Changelog ─────────────────────────────────────────────
let changelogSince = '1h';
document.querySelectorAll('.time-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.time-filter').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    changelogSince = btn.dataset.since;
    fetchChangelog();
  });
});

function toggleChangelog() {
  const cl = document.getElementById('changelog');
  cl.classList.toggle('open');
  document.getElementById('btn-changelog').classList.toggle('active');
}

async function fetchChangelog() {
  try {
    const res = await fetch(`/api/changelog?since=${changelogSince}`);
    data.changelog = await res.json();
    renderChangelog();
  } catch {}
}

function renderChangelog() {
  const el = document.getElementById('changelog-entries');
  if (!data.changelog?.entries) return;
  el.innerHTML = data.changelog.entries.slice(0, 50).map(e => `
    <div class="changelog-entry">
      <span class="changelog-agent" style="color:${e.color || '#888'}">${e.agent}</span>
      <span class="feed-time">${e.time}</span>
      <span style="color:var(--text)">${e.text}</span>
    </div>
  `).join('');
}

// ─── Data Fetching ─────────────────────────────────────────
async function fetchAll() {
  try {
    const [agents, health, projects, blocked, metrics, research] = await Promise.all([
      fetch('/api/agents').then(r => r.json()),
      fetch('/api/health').then(r => r.json()),
      fetch('/api/projects').then(r => r.json()),
      fetch('/api/blocked').then(r => r.json()),
      fetch('/api/metrics').then(r => r.json()),
      fetch('/api/research').then(r => r.json()),
    ]);
    data = { agents, health, projects, blocked, metrics, research, changelog: data.changelog };
    updateVisuals();
  } catch (e) {
    console.error('Fetch failed:', e);
  }
}

function updateVisuals() {
  // Update node data
  for (const node of nodes) {
    const agent = data.agents.find(a => a.name === node.id);
    if (!agent) continue;
    node.status = agent.status;
    node.feedCount = agent.feed?.length || 0;
    node.inboxPending = agent.inbox?.pending || 0;
  }
  
  // Update node visuals
  nodeGroup.selectAll('.node-circle')
    .transition().duration(500)
    .attr('stroke-opacity', d => d.status === 'active' ? 1 : 0.4)
    .attr('fill', d => {
      const c = d3.color(d.color);
      const opacity = d.status === 'active' ? 0.18 : 0.08;
      return `rgba(${c.r},${c.g},${c.b},${opacity})`;
    });

  // Activity fill
  nodeGroup.selectAll('.activity-fill')
    .transition().duration(500)
    .attr('r', d => d.feedCount > 0 ? Math.min(d.r * 0.6, 4 + d.feedCount * 0.5) : 0);

  // Status text
  nodeGroup.selectAll('.node-status')
    .text(d => {
      if (d.id === 'ceo') {
        const online = data.health?.summary?.online || 0;
        return `${online} services`;
      }
      return d.status === 'active' ? '● active' : d.feedCount > 0 ? `${d.feedCount} entries` : 'idle';
    });

  // Inbox badges
  nodeGroup.selectAll('.inbox-badge circle')
    .transition().duration(300)
    .attr('opacity', d => d.inboxPending > 0 ? 0.9 : 0);
  nodeGroup.selectAll('.inbox-badge text')
    .text(d => d.inboxPending > 0 ? d.inboxPending : '');

  // Top bar
  const online = data.health?.summary?.online || 0;
  const total = data.health?.summary?.total || 0;
  document.getElementById('status-services').textContent = `${online}/${total} services`;
  
  const activeAgents = data.agents.filter(a => a.status === 'active').length;
  document.getElementById('status-agents').textContent = `${activeAgents}/${data.agents.length} agents`;
  
  const totalPending = data.agents.reduce((s, a) => s + (a.inbox?.pending || 0), 0);
  document.getElementById('status-inbox').textContent = `${totalPending} inbox`;
  
  if (data.blocked?.length > 0) {
    document.getElementById('blocked-pill').style.display = '';
    document.getElementById('blocked-count').textContent = data.blocked.length;
  } else {
    document.getElementById('blocked-pill').style.display = 'none';
  }

  // Update panel if open
  if (focusedNode && document.getElementById('detail-panel').classList.contains('open')) {
    openPanel(focusedNode);
  }
}

// Initial fetch + poll
fetchAll();
fetchChangelog();
setInterval(fetchAll, 30000);
setInterval(fetchChangelog, 30000);

// ─── Controls ──────────────────────────────────────────────
window.resetView = function() {
  svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
  focusedNode = null;
};

window.togglePause = function() {
  paused = !paused;
  document.getElementById('btn-pause').textContent = paused ? '▶ Resume' : '⏸ Pause';
  document.getElementById('btn-pause').classList.toggle('active', paused);
  if (!paused) sim.alpha(0.1).restart();
};

window.toggleChangelog = toggleChangelog;
window.closePanel = closePanel;

// ─── Keyboard ──────────────────────────────────────────────
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT') {
    if (e.key === 'Escape') {
      document.getElementById('search-container').classList.remove('open');
      e.target.blur();
    }
    return;
  }
  
  if (e.key === 'Escape') {
    closePanel();
    resetView();
    document.getElementById('search-container').classList.remove('open');
    document.getElementById('changelog').classList.remove('open');
  }
  
  if (e.key === '/') {
    e.preventDefault();
    document.getElementById('search-container').classList.add('open');
    document.getElementById('search-input').focus();
  }
  
  if (e.key === ' ') {
    e.preventDefault();
    togglePause();
  }
  
  if (e.key === 'l' || e.key === 'L') {
    toggleChangelog();
  }
  
  // 1-6 jump to departments
  const idx = parseInt(e.key) - 1;
  if (idx >= 0 && idx < DEPT_ORDER.length) {
    const node = nodes.find(n => n.id === DEPT_ORDER[idx]);
    if (node) onNodeClick({ stopPropagation: () => {} }, node);
  }
});

// Search
document.getElementById('search-input').addEventListener('input', (e) => {
  const q = e.target.value.toLowerCase();
  if (!q) return;
  
  // Find matching node
  const match = nodes.find(n => n.label.toLowerCase().includes(q) || n.id.includes(q));
  if (match) {
    // Highlight it
    nodeGroup.selectAll('.node-circle')
      .transition().duration(200)
      .attr('stroke-width', d => d.id === match.id ? 3 : 1.5)
      .attr('stroke-opacity', d => d.id === match.id ? 1 : 0.3);
  }
});

// ─── Resize ────────────────────────────────────────────────
window.addEventListener('resize', () => {
  const nw = window.innerWidth, nh = window.innerHeight;
  svg.attr('width', nw).attr('height', nh);
  starCanvas.width = nw * devicePixelRatio;
  starCanvas.height = nh * devicePixelRatio;
  starCtx.scale(devicePixelRatio, devicePixelRatio);
  partCanvas.width = nw * devicePixelRatio;
  partCanvas.height = nh * devicePixelRatio;
  partCtx.scale(devicePixelRatio, devicePixelRatio);
  sim.force('center', d3.forceCenter(nw/2, nh/2));
  sim.alpha(0.3).restart();
});

</script>
</body>
</html>
