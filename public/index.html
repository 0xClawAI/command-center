<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control ‚Äî 0xClaw AI</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0A0A0F;--surface:#11111B;--surface2:#1A1A2E;--border:#2A2A3E;
  --accent:#00D4FF;--green:#00FF88;--amber:#FFB800;--red:#FF3366;--purple:#A855F7;--pink:#EC4899;
  --text:#E2E8F0;--text2:#94A3B8;--text3:#64748B;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'SF Mono','Fira Code','Cascadia Code',monospace;overflow:hidden}

#topbar{height:56px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:24px;position:relative;z-index:10}
#topbar .logo{font-size:14px;font-weight:700;letter-spacing:2px;color:var(--accent);text-transform:uppercase}
#topbar .logo span{color:var(--text3);font-weight:400}
.stat-pill{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 14px;font-size:12px;display:flex;align-items:center;gap:6px}
.stat-pill .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.stat-pill .dot.green{background:var(--green);box-shadow:0 0 6px var(--green)}
.stat-pill .dot.amber{background:var(--amber);box-shadow:0 0 6px var(--amber)}
.stat-pill .dot.red{background:var(--red);box-shadow:0 0 6px var(--red)}
.stat-pill .dot.blue{background:var(--accent);box-shadow:0 0 6px var(--accent)}
#topbar .spacer{flex:1}
#topbar .clock{color:var(--text3);font-size:12px}

#main{display:flex;height:calc(100vh - 56px)}
#graph-area{flex:1;position:relative;overflow:hidden}
#canvas{width:100%;height:100%}

#panel{width:420px;background:var(--surface);border-left:1px solid var(--border);transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);overflow-y:auto;position:relative;z-index:5;flex-shrink:0}
#panel.open{transform:translateX(0)}
#panel .panel-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:2}
#panel .panel-header h2{font-size:16px;font-weight:600;display:flex;align-items:center;gap:10px}
#panel .close-btn{background:none;border:1px solid var(--border);color:var(--text3);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
#panel .close-btn:hover{border-color:var(--accent);color:var(--accent)}
#panel .section{padding:16px 20px;border-bottom:1px solid var(--border)}
#panel .section h3{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:12px}
.feed-entry{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px;line-height:1.5}
.feed-entry .time{color:var(--accent);margin-right:8px;font-weight:600}
.feed-entry .text{color:var(--text2)}
.status-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;letter-spacing:0.5px}
.status-badge.active{background:rgba(0,255,136,0.15);color:var(--green)}
.status-badge.idle{background:rgba(148,163,184,0.15);color:var(--text3)}

#health-bar{position:absolute;bottom:0;left:0;right:0;height:48px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;overflow-x:auto;z-index:5}
.svc-chip{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:11px;background:var(--surface2);border:1px solid var(--border);white-space:nowrap;flex-shrink:0}
.svc-chip .svc-dot{width:6px;height:6px;border-radius:50%}
.svc-chip .svc-dot.online{background:var(--green)}
.svc-chip .svc-dot.stopped,.svc-chip .svc-dot.errored{background:var(--red)}

.node-tooltip{position:absolute;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:11px;pointer-events:none;opacity:0;transition:opacity .15s;z-index:20;max-width:350px}

@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

#token-breakdown-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,15,0.8);display:none;z-index:100;backdrop-filter:blur(8px)}
#token-breakdown{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;min-width:480px;max-width:600px;box-shadow:0 20px 40px rgba(0,0,0,0.5)}
#token-breakdown h2{color:var(--accent);margin-bottom:20px;display:flex;align-items:center;gap:12px}
.cost-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px}
.cost-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;text-align:center}
.cost-card .value{font-size:24px;font-weight:700;margin-bottom:4px}
.cost-card .label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3)}
.agent-tokens{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.agent-token-row{display:flex;justify-content:between;align-items:center;padding:8px 12px;background:var(--surface2);border-radius:6px}
.agent-token-row .agent-name{display:flex;align-items:center;gap:8px;flex:1}
.agent-token-row .tokens{color:var(--text2);font-size:12px}
.agent-token-row .cost{color:var(--accent);font-weight:600;font-size:13px}
#token-cost-pill:hover{border-color:var(--accent);background:rgba(0,212,255,0.05)}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:1px solid var(--border);color:var(--text3);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.modal-close:hover{border-color:var(--accent);color:var(--accent)}
#github-pill:hover{border-color:var(--accent);background:rgba(0,212,255,0.05)}
#github-breakdown-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,15,0.8);display:none;z-index:100;backdrop-filter:blur(8px)}
#github-breakdown{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;min-width:600px;max-width:800px;box-shadow:0 20px 40px rgba(0,0,0,0.5)}
.commit-item{padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;background:var(--surface2)}
.commit-item .commit-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.commit-item .commit-sha{font-family:monospace;background:var(--surface);padding:2px 6px;border-radius:4px;font-size:11px;color:var(--accent)}
.commit-item .commit-repo{font-size:11px;color:var(--text3)}
.commit-item .commit-message{font-size:13px;color:var(--text);line-height:1.4;margin-bottom:4px}
.commit-item .commit-date{font-size:11px;color:var(--text3)}

/* Alert Banner Styles */
#alert-banner{position:fixed;top:0;left:0;right:0;background:var(--red);color:#fff;padding:8px 16px;display:none;z-index:300;border-bottom:1px solid rgba(255,255,255,0.2);backdrop-filter:blur(8px);font-size:13px;font-weight:500;align-items:center;justify-content:space-between;gap:16px}
#alert-banner.show{display:flex;animation:alertSlideIn 0.3s ease-out}
#alert-banner.critical{background:var(--red);box-shadow:0 0 20px rgba(255,51,102,0.4)}
#alert-banner.warning{background:var(--amber);color:#000}
#alert-banner.error{background:var(--red)}
.alert-content{flex:1;display:flex;align-items:center;gap:12px}
.alert-icon{font-size:16px;flex-shrink:0}
.alert-message{flex:1;line-height:1.4}
.alert-dismiss{background:none;border:1px solid rgba(255,255,255,0.3);color:inherit;width:24px;height:24px;border-radius:4px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
#alert-banner.warning .alert-dismiss{border-color:rgba(0,0,0,0.3)}
.alert-dismiss:hover{background:rgba(255,255,255,0.1)}
#alert-banner.warning .alert-dismiss:hover{background:rgba(0,0,0,0.1)}
@keyframes alertSlideIn{from{transform:translateY(-100%)}to{transform:translateY(0)}}

/* Adjust main layout to account for alert banner */
body.alert-active #topbar{top:40px}
body.alert-active #main{height:calc(100vh - 96px);margin-top:40px}

/* Help Overlay Styles */
#help-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,15,0.9);display:none;z-index:200;backdrop-filter:blur(8px);align-items:center;justify-content:center}
#help-overlay.open{display:flex}
#help-content{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:32px;max-width:500px;box-shadow:0 20px 40px rgba(0,0,0,0.6);position:relative}
#help-content h2{color:var(--accent);margin-bottom:24px;display:flex;align-items:center;gap:12px;font-size:18px}
.help-section{margin-bottom:20px}
.help-section h3{color:var(--text3);font-size:11px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:8px}
.shortcut-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:13px}
.shortcut-key{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-family:monospace;font-size:11px;color:var(--accent);font-weight:700;min-width:24px;text-align:center}
.shortcut-desc{color:var(--text2);flex:1;margin-left:16px}
.help-footer{margin-top:24px;padding-top:16px;border-top:1px solid var(--border);color:var(--text3);font-size:11px;text-align:center}

/* Navigation feedback */
.agent-highlight{animation:agentPulse 0.6s ease-out}
@keyframes agentPulse{0%{transform:scale(1);box-shadow:0 0 0 0 var(--accent)}50%{transform:scale(1.05);box-shadow:0 0 0 8px rgba(0,212,255,0.3)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,212,255,0)}}
</style>
</head>
<body>

<!-- Alert Banner -->
<div id="alert-banner">
  <div class="alert-content">
    <span class="alert-icon" id="alert-icon">‚ö†Ô∏è</span>
    <span class="alert-message" id="alert-message">System alert message</span>
  </div>
  <button class="alert-dismiss" onclick="dismissAlert()">‚úï</button>
</div>

<div id="topbar">
  <div class="logo">‚¨° MISSION CONTROL <span>/ 0xClaw AI</span></div>
  <div class="stat-pill"><span class="dot green"></span><span id="agents-online">0</span> Agents Active</div>
  <div class="stat-pill"><span class="dot amber"></span><span id="inbox-count">0</span> Pending</div>
  <div class="stat-pill"><span class="dot green"></span><span id="services-count">0/0</span> Services</div>
  <div class="stat-pill" id="token-cost-pill" style="cursor:pointer" onclick="showTokenBreakdown()"><span class="dot blue"></span><span id="token-cost">$0.00</span> <span style="color:var(--text3)">‚Ä¢</span> <span id="token-count" style="color:var(--text3);font-size:10px">0 tokens</span></div>
  <div class="stat-pill" id="github-pill" style="cursor:pointer" onclick="showGitHubBreakdown()"><span class="dot" id="github-dot"></span><span id="github-pushes">0</span> Pushes Today</div>
  <div class="stat-pill" id="twitter-pill"><span class="dot" id="twitter-dot"></span><span id="twitter-followers">0</span> Followers</div>
  <div class="spacer"></div>
  <div class="clock" id="clock"></div>
</div>

<div id="main">
  <div id="graph-area">
    <canvas id="canvas"></canvas>
    <div class="node-tooltip" id="tooltip"></div>
    <div id="health-bar"></div>
  </div>
  <div id="panel">
    <div class="panel-header">
      <h2 id="panel-title">Agent</h2>
      <button class="close-btn" onclick="closePanel()">‚úï</button>
    </div>
    <div id="panel-content"></div>
  </div>
</div>

<!-- Token Breakdown Modal -->
<div id="token-breakdown-modal" onclick="if(event.target === this) hideTokenBreakdown()">
  <div id="token-breakdown">
    <button class="modal-close" onclick="hideTokenBreakdown()">‚úï</button>
    <h2>üí∞ Token Usage & Costs</h2>
    <div class="cost-summary">
      <div class="cost-card">
        <div class="value" style="color:var(--accent)" id="total-tokens-today">0</div>
        <div class="label">Tokens Today</div>
      </div>
      <div class="cost-card">
        <div class="value" style="color:var(--green)" id="total-cost-today">$0.00</div>
        <div class="label">Cost Today</div>
      </div>
      <div class="cost-card">
        <div class="value" style="color:var(--amber)" id="total-cost-week">$0.00</div>
        <div class="label">Cost This Week</div>
      </div>
    </div>
    <h3 style="color:var(--text3);font-size:11px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:16px">Per-Agent Breakdown</h3>
    <div class="agent-tokens" id="agent-tokens-grid"></div>
  </div>
</div>

<!-- GitHub Activity Modal -->
<div id="github-breakdown-modal" onclick="if(event.target === this) hideGitHubBreakdown()">
  <div id="github-breakdown">
    <button class="modal-close" onclick="hideGitHubBreakdown()">‚úï</button>
    <h2>üìä GitHub Activity</h2>
    <div class="cost-summary">
      <div class="cost-card">
        <div class="value" style="color:var(--green)" id="pushes-today-count">0</div>
        <div class="label">Pushes Today</div>
      </div>
      <div class="cost-card">
        <div class="value" style="color:var(--accent)" id="active-repos-count">0</div>
        <div class="label">Active Repos</div>
      </div>
      <div class="cost-card">
        <div class="value" style="color:var(--amber)" id="total-repos-count">0</div>
        <div class="label">Total Repos</div>
      </div>
    </div>

    <h3 style="color:var(--text3);font-size:11px;text-transform:uppercase;letter-spacing:1.5px;margin:20px 0 12px 0">Recent Commits</h3>
    <div id="github-commits-list" style="max-height:320px;overflow-y:auto"></div>
  </div>
</div>

<!-- Help Overlay -->
<div id="help-overlay" onclick="if(event.target === this) hideHelp()">
  <div id="help-content">
    <button class="modal-close" onclick="hideHelp()">‚úï</button>
    <h2>‚å®Ô∏è Keyboard Shortcuts</h2>

    <div class="help-section">
      <h3>Agent Navigation</h3>
      <div class="shortcut-row">
        <kbd class="shortcut-key">1</kbd>
        <span class="shortcut-desc">Open CEO Agent Panel</span>
      </div>
      <div class="shortcut-row">
        <kbd class="shortcut-key">2</kbd>
        <span class="shortcut-desc">Open Engineering Agent Panel</span>
      </div>
      <div class="shortcut-row">
        <kbd class="shortcut-key">3</kbd>
        <span class="shortcut-desc">Open Content Agent Panel</span>
      </div>
      <div class="shortcut-row">
        <kbd class="shortcut-key">4</kbd>
        <span class="shortcut-desc">Open Comms Agent Panel</span>
      </div>
      <div class="shortcut-row">
        <kbd class="shortcut-key">5</kbd>
        <span class="shortcut-desc">Open Research Agent Panel</span>
      </div>
      <div class="shortcut-row">
        <kbd class="shortcut-key">6</kbd>
        <span class="shortcut-desc">Open QA Agent Panel</span>
      </div>
    </div>

    <div class="help-section">
      <h3>System Controls</h3>
      <div class="shortcut-row">
        <kbd class="shortcut-key">R</kbd>
        <span class="shortcut-desc">Refresh All Data</span>
      </div>
      <div class="shortcut-row">
        <kbd class="shortcut-key">T</kbd>
        <span class="shortcut-desc">Toggle Token Usage Breakdown</span>
      </div>
      <div class="shortcut-row">
        <kbd class="shortcut-key">G</kbd>
        <span class="shortcut-desc">Toggle GitHub Activity Breakdown</span>
      </div>
      <div class="shortcut-row">
        <kbd class="shortcut-key">Esc</kbd>
        <span class="shortcut-desc">Close All Panels & Modals</span>
      </div>
    </div>

    <div class="help-section">
      <h3>Help & Information</h3>
      <div class="shortcut-row">
        <kbd class="shortcut-key">?</kbd>
        <span class="shortcut-desc">Show This Help (you're here!)</span>
      </div>
    </div>

    <div class="help-footer">
      Press <kbd class="shortcut-key">Esc</kbd> or click outside to close
    </div>
  </div>
</div>

<script>
let agents = [], health = { services: [], summary: {} }, inboxData = {}, metrics = {}, github = {}, twitter = {};
let selectedAgent = null, hoveredNode = null, animFrame = 0;
let agentFlowData = {}; // Track message flows between agents
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const COLORS = { ceo:'#00D4FF', engineering:'#A855F7', content:'#EC4899', comms:'#FFB800', research:'#00FF88', qa:'#FF3366' };
const ICONS = { ceo:'üëë', engineering:'‚öôÔ∏è', content:'‚úçÔ∏è', comms:'üì°', research:'üî¨', qa:'üõ°Ô∏è' };
const LABELS = { ceo:'CEO', engineering:'Engineering', content:'Content', comms:'Comms', research:'Research', qa:'QA' };

function resize() {
  const r = canvas.parentElement.getBoundingClientRect();
  canvas.width = r.width * devicePixelRatio;
  canvas.height = r.height * devicePixelRatio;
  canvas.style.width = r.width + 'px';
  canvas.style.height = r.height + 'px';
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
}
window.addEventListener('resize', resize);
resize();

function getNodes() {
  const w = canvas.clientWidth, h = canvas.clientHeight - 48;
  const cx = w / 2, cy = h / 2;
  const r = Math.min(w, h) * 0.28;
  const depts = ['engineering','content','comms','research','qa'];
  const nodes = [{ name:'ceo', x:cx, y:cy, r:48 }];
  depts.forEach((d, i) => {
    const a = -Math.PI/2 + (i * 2 * Math.PI / 5);
    nodes.push({ name:d, x:cx + r*Math.cos(a), y:cy + r*Math.sin(a), r:36 });
  });
  return nodes;
}

// Calculate agent interaction intensity based on activity patterns and timing
function calculateAgentFlowIntensity(fromAgent, toAgent) {
  if (!agents || agents.length === 0) return 0;

  const from = agents.find(a => a.name === fromAgent);
  const to = agents.find(a => a.name === toAgent);

  if (!from || !to) return 0;

  // Base intensity from activity levels
  const fromActivity = (from.feed?.length || 0) / 20;
  const toActivity = (to.feed?.length || 0) / 20;
  const fromInbox = (from.inbox?.pending || 0) / 10;
  const toInbox = (to.inbox?.pending || 0) / 10;

  // Combined flow intensity
  const baseFlow = Math.min((fromActivity + toActivity + fromInbox + toInbox) / 4, 1.0);

  // Add time-based correlation (simulated)
  const timeCorrelation = fromAgent === 'ceo' ?
    Math.min((toActivity + toInbox) * 1.2, 1.0) : // CEO delegates heavily
    Math.min((fromActivity + fromInbox) * 0.8, 1.0); // Agents report back

  return Math.min(baseFlow * 0.6 + timeCorrelation * 0.4, 1.0);
}

// Enhanced Particles with Flow-based Scaling
let particles = [];
function tickParticles() {
  const nodes = getNodes();
  const ceo = nodes[0];

  for (let i = 1; i < nodes.length; i++) {
    const n = nodes[i];

    // Calculate bidirectional flow intensities
    const ceoToAgentFlow = calculateAgentFlowIntensity('ceo', n.name);
    const agentToCeoFlow = calculateAgentFlowIntensity(n.name, 'ceo');

    // CEO to Agent particles
    if (ceoToAgentFlow > 0.05 && Math.random() < 0.01 + (ceoToAgentFlow * 0.06)) {
      const particleCount = Math.ceil(1 + ceoToAgentFlow * 2.5);
      for (let j = 0; j < particleCount; j++) {
        const speed = 0.003 + Math.random() * 0.004 + (ceoToAgentFlow * 0.008);
        const size = 1.8 + (ceoToAgentFlow * 2.2);

        particles.push({
          from: ceo,
          to: n,
          t: 0,
          speed,
          color: COLORS[n.name],
          size,
          heat: ceoToAgentFlow,
          offset: j * 0.15,
          direction: 'outbound'
        });
      }
    }

    // Agent to CEO particles
    if (agentToCeoFlow > 0.05 && Math.random() < 0.008 + (agentToCeoFlow * 0.05)) {
      const particleCount = Math.ceil(1 + agentToCeoFlow * 2);
      for (let j = 0; j < particleCount; j++) {
        const speed = 0.004 + Math.random() * 0.005 + (agentToCeoFlow * 0.006);
        const size = 1.5 + (agentToCeoFlow * 1.8);

        particles.push({
          from: n,
          to: ceo,
          t: 0,
          speed,
          color: COLORS[n.name],
          size,
          heat: agentToCeoFlow,
          offset: j * 0.12,
          direction: 'inbound'
        });
      }
    }
  }

  // Dynamic particle limit based on total flow activity
  const totalFlowActivity = nodes.slice(1).reduce((sum, n) =>
    sum + calculateAgentFlowIntensity('ceo', n.name) + calculateAgentFlowIntensity(n.name, 'ceo'), 0);
  const maxParticles = Math.max(80, Math.min(80 + totalFlowActivity * 30, 200));

  if (particles.length > maxParticles) {
    particles = particles.slice(-Math.floor(maxParticles * 0.85));
  }
}

function draw() {
  const w = canvas.clientWidth, h = canvas.clientHeight;
  ctx.clearRect(0, 0, w, h);

  // Grid
  ctx.strokeStyle = 'rgba(0,212,255,0.03)';
  ctx.lineWidth = 1;
  for (let x = 0; x < w; x += 50) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke(); }
  for (let y = 0; y < h; y += 50) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke(); }

  const nodes = getNodes();
  const ceo = nodes[0];
  const t = animFrame;

  // Radar sweep
  const sweep = (t * 0.006) % (Math.PI * 2);
  try {
    const sg = ctx.createConicGradient(sweep, ceo.x, ceo.y);
    sg.addColorStop(0, 'rgba(0,212,255,0.05)');
    sg.addColorStop(0.08, 'rgba(0,212,255,0)');
    sg.addColorStop(1, 'rgba(0,212,255,0)');
    ctx.fillStyle = sg;
    ctx.beginPath(); ctx.arc(ceo.x, ceo.y, Math.min(w,h)*0.4, 0, Math.PI*2); ctx.fill();
  } catch(e) {}

  // Concentric rings
  for (let i = 1; i <= 3; i++) {
    ctx.beginPath();
    ctx.arc(ceo.x, ceo.y, Math.min(w,h)*0.13*i, 0, Math.PI*2);
    ctx.strokeStyle = 'rgba(0,212,255,0.04)';
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  // Enhanced Edges with Heat Map and Flow Intensity
  for (let i = 1; i < nodes.length; i++) {
    const n = nodes[i];
    const agent = agents.find(a => a.name === n.name);

    // Calculate bidirectional flow intensity
    const ceoToAgentFlow = calculateAgentFlowIntensity('ceo', n.name);
    const agentToCeoFlow = calculateAgentFlowIntensity(n.name, 'ceo');
    const maxFlow = Math.max(ceoToAgentFlow, agentToCeoFlow);
    const totalFlow = (ceoToAgentFlow + agentToCeoFlow) / 2;

    // Heat intensity combines flow data with real activity
    const heatIntensity = Math.min(totalFlow * 1.2, 1.0);

    // Edge thickness varies from 1.2 to 7 based on heat
    const edgeThickness = 1.2 + (heatIntensity * 5.8);

    // Alpha varies from 0.06 to 0.85 for strong heat map effect
    const alpha = 0.06 + (heatIntensity * 0.79);

    // Control point for curve
    const mx = (ceo.x + n.x) / 2, my = (ceo.y + n.y) / 2;
    const dx = n.y - ceo.y, dy = -(n.x - ceo.x);
    const len = Math.sqrt(dx*dx + dy*dy) || 1;
    const off = 18 * Math.sin(t * 0.008 + i);
    const cpx = mx + (dx/len)*off, cpy = my + (dy/len)*off;

    // Draw outer glow first for layering effect
    if (heatIntensity > 0.3) {
      ctx.beginPath();
      ctx.moveTo(ceo.x, ceo.y);
      ctx.quadraticCurveTo(cpx, cpy, n.x, n.y);
      const outerGlowAlpha = Math.round(heatIntensity * 25).toString(16).padStart(2, '0');
      ctx.strokeStyle = COLORS[n.name] + outerGlowAlpha;
      ctx.lineWidth = edgeThickness + 12;
      ctx.stroke();
    }

    // Main edge with heat-based styling
    ctx.beginPath();
    ctx.moveTo(ceo.x, ceo.y);
    ctx.quadraticCurveTo(cpx, cpy, n.x, n.y);
    const hex = Math.round(alpha * 255).toString(16).padStart(2, '0');
    ctx.strokeStyle = COLORS[n.name] + hex;
    ctx.lineWidth = edgeThickness;
    ctx.stroke();

    // Add inner glow for high-intensity flows
    if (heatIntensity > 0.6) {
      ctx.beginPath();
      ctx.moveTo(ceo.x, ceo.y);
      ctx.quadraticCurveTo(cpx, cpy, n.x, n.y);
      const innerGlowAlpha = Math.round((heatIntensity - 0.6) * 120).toString(16).padStart(2, '0');
      ctx.strokeStyle = COLORS[n.name] + innerGlowAlpha;
      ctx.lineWidth = edgeThickness * 0.4;
      ctx.stroke();

      // Ultra-bright core for maximum intensity
      if (heatIntensity > 0.8) {
        ctx.beginPath();
        ctx.moveTo(ceo.x, ceo.y);
        ctx.quadraticCurveTo(cpx, cpy, n.x, n.y);
        ctx.strokeStyle = '#ffffff' + Math.round((heatIntensity - 0.8) * 100).toString(16).padStart(2, '0');
        ctx.lineWidth = edgeThickness * 0.15;
        ctx.stroke();
      }
    }
  }

  // Enhanced Flow Particles
  tickParticles();
  particles = particles.filter(p => {
    p.t += p.speed;
    if (p.t > 1) return false;

    const mx = (p.from.x + p.to.x)/2, my = (p.from.y + p.to.y)/2;
    const dx = p.to.y - p.from.y, dy = -(p.to.x - p.from.x);
    const len = Math.sqrt(dx*dx+dy*dy) || 1;
    const off = 18 * Math.sin(t*0.008 + (p.offset || 0));
    const cpx = mx + (dx/len)*off, cpy = my + (dy/len)*off;

    const tt = p.t;
    const x = (1-tt)*(1-tt)*p.from.x + 2*(1-tt)*tt*cpx + tt*tt*p.to.x;
    const y = (1-tt)*(1-tt)*p.from.y + 2*(1-tt)*tt*cpy + tt*tt*p.to.y;

    // Enhanced alpha curve with flow-based intensity
    const flowMultiplier = p.direction === 'outbound' ? 1.1 : 0.9; // Outbound slightly brighter
    const a = Math.sin(tt * Math.PI) * (0.6 + p.heat * 0.4) * flowMultiplier;
    const size = p.size || 2.5;

    // Directional glow effects
    const glowRadius = p.direction === 'outbound' ?
      10 + (p.heat * 8) : // Delegation flows larger
      7 + (p.heat * 5);   // Reporting flows smaller

    const glowAlpha = Math.round(a * (15 + p.heat * 35));
    ctx.beginPath();
    ctx.arc(x, y, glowRadius, 0, Math.PI*2);
    ctx.fillStyle = p.color + glowAlpha.toString(16).padStart(2,'0');
    ctx.fill();

    // Core with directional characteristics
    const coreRadius = size + (p.heat * 2);
    let coreColor = p.color;

    // CEO delegation particles get subtle blue tint for outbound
    if (p.direction === 'outbound' && p.heat > 0.5) {
      const blueBlend = Math.round(p.heat * 30);
      coreColor = `rgb(${Math.min(255, parseInt(p.color.slice(1,3), 16) + blueBlend)}, ${Math.min(255, parseInt(p.color.slice(3,5), 16) + blueBlend * 0.8)}, ${Math.min(255, parseInt(p.color.slice(5,7), 16) + blueBlend * 1.5)})`;
    }

    const coreAlpha = Math.round(a * (160 + p.heat * 80));
    ctx.beginPath();
    ctx.arc(x, y, coreRadius, 0, Math.PI*2);
    if (coreColor.startsWith('rgb')) {
      ctx.fillStyle = coreColor.replace('rgb', 'rgba').replace(')', `, ${coreAlpha/255})`);
    } else {
      ctx.fillStyle = coreColor + coreAlpha.toString(16).padStart(2,'0');
    }
    ctx.fill();

    // Ultra-bright center for maximum flow intensity
    if (p.heat > 0.7) {
      ctx.beginPath();
      ctx.arc(x, y, 1.5, 0, Math.PI*2);
      const centerAlpha = Math.round(a * (150 + p.heat * 100));
      ctx.fillStyle = '#ffffff' + centerAlpha.toString(16).padStart(2,'0');
      ctx.fill();
    }

    // Trailing effect for high-speed particles
    if (p.heat > 0.8 && tt > 0.3) {
      const trailT = Math.max(0, tt - 0.15);
      const trailX = (1-trailT)*(1-trailT)*p.from.x + 2*(1-trailT)*trailT*cpx + trailT*trailT*p.to.x;
      const trailY = (1-trailT)*(1-trailT)*p.from.y + 2*(1-trailT)*trailT*cpy + trailT*trailT*p.to.y;

      ctx.beginPath();
      ctx.arc(trailX, trailY, coreRadius * 0.6, 0, Math.PI*2);
      ctx.fillStyle = p.color + '20';
      ctx.fill();
    }

    return true;
  });

  // Nodes
  for (const n of nodes) {
    const agent = agents.find(a => a.name === n.name);
    const isHov = hoveredNode === n.name;
    const isSel = selectedAgent === n.name;
    const col = COLORS[n.name];
    const feedLen = agent ? agent.feed.length : 0;
    const breathe = 1 + 0.025 * Math.sin(t * 0.035 + nodes.indexOf(n) * 1.2);
    const nr = n.r * breathe * (isHov ? 1.1 : 1);

    // Outer glow
    const grad = ctx.createRadialGradient(n.x, n.y, nr*0.3, n.x, n.y, nr*2.2);
    grad.addColorStop(0, col + '25');
    grad.addColorStop(1, col + '00');
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(n.x, n.y, nr*2.2, 0, Math.PI*2); ctx.fill();

    // Hexagon
    ctx.beginPath();
    for (let j = 0; j < 6; j++) {
      const a = Math.PI/6 + j * Math.PI/3;
      const px = n.x + nr * Math.cos(a), py = n.y + nr * Math.sin(a);
      j === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
    }
    ctx.closePath();
    ctx.fillStyle = isSel ? col + '20' : '#0A0A0F';
    ctx.fill();
    ctx.strokeStyle = col + (isSel ? 'ff' : isHov ? 'cc' : '80');
    ctx.lineWidth = isSel ? 2.5 : isHov ? 2 : 1.5;
    ctx.stroke();

    // Activity arc
    if (feedLen > 0) {
      const arc = Math.min(feedLen / 15, 1) * Math.PI * 2;
      ctx.beginPath(); ctx.arc(n.x, n.y, nr + 8, -Math.PI/2, -Math.PI/2 + arc);
      ctx.strokeStyle = col + '60';
      ctx.lineWidth = 2.5;
      ctx.lineCap = 'round';
      ctx.stroke();
      ctx.lineCap = 'butt';
    }

    // Icon
    ctx.font = n.name === 'ceo' ? '24px serif' : '20px serif';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(ICONS[n.name], n.x, n.y - 1);

    // Label
    ctx.font = '600 10px "SF Mono","Fira Code",monospace';
    ctx.fillStyle = isHov || isSel ? col : '#94A3B8';
    ctx.fillText(LABELS[n.name] || n.name.toUpperCase(), n.x, n.y + nr + 18);

    // Status dot
    const status = agent ? agent.status : 'idle';
    const dotCol = status === 'active' ? '#00FF88' : '#64748B';
    ctx.beginPath(); ctx.arc(n.x, n.y + nr + 28, 3, 0, Math.PI*2);
    ctx.fillStyle = dotCol;
    ctx.fill();

    // Inbox badge
    if (agent && agent.inbox.pending > 0) {
      const bx = n.x + nr*0.65, by = n.y - nr*0.65;
      ctx.beginPath(); ctx.arc(bx, by, 11, 0, Math.PI*2);
      ctx.fillStyle = '#FF3366';
      ctx.fill();
      ctx.font = '700 9px monospace';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(String(agent.inbox.pending), bx, by + 1);
    }
  }

  animFrame++;
  requestAnimationFrame(draw);
}

// Hit detection
canvas.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const nodes = getNodes();
  let found = null;
  for (const n of nodes) {
    if (Math.hypot(mx - n.x, my - n.y) < n.r + 10) { found = n.name; break; }
  }
  hoveredNode = found;
  canvas.style.cursor = found ? 'pointer' : 'default';
  const tip = document.getElementById('tooltip');
  if (found) {
    const agent = agents.find(a => a.name === found);
    const last = agent && agent.lastActivity;
    tip.innerHTML = '<strong style="color:'+COLORS[found]+'">'+LABELS[found]+'</strong>' + (last ? '<br><span style="color:#00D4FF">'+last.time+'</span> '+last.text.slice(0,80) : '');
    tip.style.left = (mx + 16) + 'px';
    tip.style.top = (my - 10) + 'px';
    tip.style.opacity = '1';
  } else {
    tip.style.opacity = '0';
  }
});

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  for (const n of getNodes()) {
    if (Math.hypot(mx - n.x, my - n.y) < n.r + 10) { openPanel(n.name); return; }
  }
});

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function openPanel(name) {
  selectedAgent = name;
  const agent = agents.find(a => a.name === name) || { name, feed:[], inbox:{pending:0,total:0}, status:'idle' };
  const col = COLORS[name];

  document.getElementById('panel-title').innerHTML =
    ICONS[name]+' <span style="color:'+col+'">'+LABELS[name]+'</span> <span class="status-badge '+agent.status+'">'+agent.status+'</span>';

  let html = '';
  html += '<div class="section"><h3>Overview</h3><div style="display:flex;gap:24px;font-size:13px">';
  html += '<div><span style="color:'+col+';font-size:24px;font-weight:700">'+agent.feed.length+'</span><br><span style="color:var(--text3)">Feed Entries</span></div>';
  html += '<div><span style="color:var(--amber);font-size:24px;font-weight:700">'+agent.inbox.pending+'</span><br><span style="color:var(--text3)">Inbox Pending</span></div>';
  html += '<div><span style="color:var(--text2);font-size:24px;font-weight:700">'+agent.inbox.total+'</span><br><span style="color:var(--text3)">Total Items</span></div>';
  html += '</div></div>';

  // Add GitHub section for Engineering agent
  if (name === 'engineering' && github.username) {
    html += '<div class="section"><h3>GitHub Activity</h3>';
    if (github.error) {
      html += '<div style="color:var(--text3);font-size:11px;padding:8px 0">'+escHtml(github.error)+'</div>';
    } else {
      // Summary stats
      html += '<div style="display:flex;gap:16px;margin-bottom:16px;font-size:12px">';
      html += '<div><span style="color:var(--accent);font-size:20px;font-weight:700">'+github.pushesToday+'</span><br><span style="color:var(--text3)">Pushes Today</span></div>';
      html += '<div><span style="color:var(--green);font-size:20px;font-weight:700">'+github.activeRepos.length+'</span><br><span style="color:var(--text3)">Active Repos</span></div>';
      html += '<div><span style="color:var(--text2);font-size:20px;font-weight:700">'+github.totalRepos+'</span><br><span style="color:var(--text3)">Total Repos</span></div>';
      html += '</div>';

      // Recent commits
      if (github.recentCommits && github.recentCommits.length > 0) {
        html += '<h4 style="color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Recent Commits</h4>';
        for (const commit of github.recentCommits.slice(0, 8)) {
          const date = new Date(commit.date);
          const timeStr = date.toLocaleDateString() === new Date().toLocaleDateString() ?
            date.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:false}) :
            date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
          const repoDisplay = commit.repo === 'current' ? commit.repo : commit.repo.split('/').pop();

          html += '<div class="feed-entry">';
          html += '<span class="time">'+timeStr+'</span>';
          html += '<span style="color:var(--accent);margin-right:8px;font-family:monospace;font-size:11px">'+commit.sha+'</span>';
          html += '<span style="color:var(--text3);margin-right:8px;font-size:10px">'+repoDisplay+'</span>';
          html += '<span class="text">'+escHtml(commit.message)+'</span>';
          html += '</div>';
        }
      } else {
        html += '<div style="color:var(--text3);font-size:11px;padding:8px 0">No recent commits found</div>';
      }

      // Active repositories
      if (github.activeRepos && github.activeRepos.length > 0) {
        html += '<h4 style="color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px 0">Active Repositories</h4>';
        for (const repo of github.activeRepos.slice(0, 5)) {
          html += '<div style="padding:4px 0;font-size:11px;color:var(--text2)">üìÇ '+escHtml(repo)+'</div>';
        }
      }
    }
    html += '</div>';
  }

  // Add Twitter section for Comms agent
  if (name === 'comms' && twitter.username) {
    html += '<div class="section"><h3>Twitter Activity</h3>';
    if (twitter.error) {
      html += '<div style="color:var(--text3);font-size:11px;padding:8px 0">'+escHtml(twitter.error)+'</div>';
    } else {
      // Summary stats
      html += '<div style="display:flex;gap:16px;margin-bottom:16px;font-size:12px">';
      html += '<div><span style="color:var(--accent);font-size:20px;font-weight:700">'+twitter.followers.toLocaleString()+'</span><br><span style="color:var(--text3)">Followers</span></div>';
      html += '<div><span style="color:var(--green);font-size:20px;font-weight:700">'+(twitter.engagement?.rate || 0)+'%</span><br><span style="color:var(--text3)">Engagement</span></div>';
      html += '<div><span style="color:var(--text2);font-size:20px;font-weight:700">'+(twitter.tweetsToday || 0)+'</span><br><span style="color:var(--text3)">Tweets Today</span></div>';
      html += '</div>';

      // Engagement breakdown
      if (twitter.engagement) {
        html += '<div style="display:flex;gap:12px;margin-bottom:16px;font-size:11px;color:var(--text2)">';
        html += '<span>‚ù§Ô∏è '+twitter.engagement.likes+'</span>';
        html += '<span>üîÅ '+twitter.engagement.retweets+'</span>';
        html += '<span>üí¨ '+twitter.engagement.replies+'</span>';
        html += '<span>üëÅÔ∏è '+twitter.engagement.impressions.toLocaleString()+'</span>';
        html += '</div>';
      }

      // Top tweets
      if (twitter.topTweets && twitter.topTweets.length > 0) {
        html += '<h4 style="color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Top Recent Tweets</h4>';
        for (const tweet of twitter.topTweets.slice(0, 3)) {
          const date = new Date(tweet.timestamp);
          const timeStr = date.toLocaleDateString() === new Date().toLocaleDateString() ?
            date.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:false}) :
            date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
          const engagement = tweet.likes + tweet.retweets + tweet.replies;

          html += '<div class="feed-entry" style="border-left:3px solid var(--accent);padding-left:8px;margin:8px 0">';
          html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
          html += '<span class="time">'+timeStr+'</span>';
          html += '<span style="color:var(--text3);font-size:10px">'+engagement+' engagements</span>';
          html += '</div>';
          html += '<div class="text" style="margin-bottom:6px">'+escHtml(tweet.text)+'</div>';
          html += '<div style="display:flex;gap:12px;font-size:10px;color:var(--text3)">';
          html += '<span>‚ù§Ô∏è '+tweet.likes+'</span>';
          html += '<span>üîÅ '+tweet.retweets+'</span>';
          html += '<span>üí¨ '+tweet.replies+'</span>';
          html += '</div>';
          html += '</div>';
        }
      } else {
        html += '<div style="color:var(--text3);font-size:11px;padding:8px 0">No recent tweets found</div>';
      }
    }
    html += '</div>';
  }

  html += '<div class="section"><h3>Recent Activity</h3>';
  if (agent.feed.length === 0) {
    html += '<div style="color:var(--text3);font-size:12px;padding:12px 0">No activity recorded</div>';
  } else {
    for (const e of agent.feed.slice(0, 20)) {
      html += '<div class="feed-entry"><span class="time">'+e.time+'</span><span class="text">'+escHtml(e.text)+'</span></div>';
    }
  }
  html += '</div>';

  document.getElementById('panel-content').innerHTML = html;
  document.getElementById('panel').classList.add('open');
}

function closePanel() {
  selectedAgent = null;
  document.getElementById('panel').classList.remove('open');
}

function renderHealthBar(services) {
  const bar = document.getElementById('health-bar');
  bar.innerHTML = '<span style="color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:1.5px;flex-shrink:0;margin-right:4px">SERVICES</span>' +
    services.map(s =>
      '<div class="svc-chip"><span class="svc-dot '+s.status+'"></span>'+s.name+'<span style="color:var(--text3);margin-left:4px">'+s.memory+'MB</span></div>'
    ).join('');
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleString('en-US', {
    weekday:'short', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZoneName:'short'
  });
}
setInterval(updateClock, 1000);
updateClock();

async function fetchAll() {
  try {
    const [agentRes, healthRes, inboxRes, metricsRes, githubRes, twitterRes] = await Promise.all([
      fetch('/api/agents').then(r=>r.json()),
      fetch('/api/health').then(r=>r.json()),
      fetch('/api/inboxes').then(r=>r.json()),
      fetch('/api/metrics').then(r=>r.json()),
      fetch('/api/github').then(r=>r.json()),
      fetch('/api/twitter').then(r=>r.json()),
    ]);
    agents = agentRes;
    health = healthRes;
    inboxData = inboxRes;
    metrics = metricsRes;
    github = githubRes;
    twitter = twitterRes;
    const active = agents.filter(a => a.status === 'active').length;
    document.getElementById('agents-online').textContent = active;
    document.getElementById('inbox-count').textContent = inboxRes.totalPending;
    document.getElementById('services-count').textContent = healthRes.summary.online+'/'+healthRes.summary.total;

    // Update token cost ticker
    if (metricsRes.costs && metricsRes.tokenUsage) {
      const costElement = document.getElementById('token-cost');
      const countElement = document.getElementById('token-count');
      costElement.textContent = `$${metricsRes.costs.today.toFixed(2)}`;
      const tokensK = Math.round(metricsRes.tokenUsage.today / 1000);
      countElement.textContent = `${tokensK}k tokens`;
      // Update title to show additional info on hover
      const costPill = document.getElementById('token-cost-pill');
      costPill.title = `Click for breakdown ‚Ä¢ $${metricsRes.costs.week.toFixed(2)} this week`;
    }

    // Update GitHub activity
    if (githubRes) {
      const pushesElement = document.getElementById('github-pushes');
      const dotElement = document.getElementById('github-dot');
      const pillElement = document.getElementById('github-pill');

      pushesElement.textContent = githubRes.pushesToday || 0;

      // Set dot color based on activity
      if (githubRes.error) {
        dotElement.className = 'dot red';
        pillElement.title = githubRes.error;
      } else if (githubRes.pushesToday > 0) {
        dotElement.className = 'dot green';
        pillElement.title = `${githubRes.pushesToday} pushes today ‚Ä¢ ${githubRes.activeRepos.length} active repos ‚Ä¢ ${githubRes.username}`;
      } else {
        dotElement.className = 'dot amber';
        pillElement.title = `No pushes today ‚Ä¢ ${githubRes.activeRepos.length} active repos ‚Ä¢ ${githubRes.username}`;
      }
    }

    // Update Twitter activity
    if (twitterRes) {
      const followersElement = document.getElementById('twitter-followers');
      const dotElement = document.getElementById('twitter-dot');
      const pillElement = document.getElementById('twitter-pill');

      followersElement.textContent = (twitterRes.followers || 0).toLocaleString();

      // Set dot color based on engagement
      const engagementRate = twitterRes.engagement?.rate || 0;
      if (engagementRate > 3.0) {
        dotElement.className = 'dot green'; // High engagement
      } else if (engagementRate > 1.5) {
        dotElement.className = 'dot amber'; // Moderate engagement
      } else {
        dotElement.className = 'dot red'; // Low engagement
      }

      // Set tooltip with detailed metrics
      const eng = twitterRes.engagement || {};
      pillElement.title = `${eng.rate || 0}% engagement ‚Ä¢ ${eng.likes || 0} likes ‚Ä¢ ${eng.retweets || 0} retweets today ‚Ä¢ @${twitterRes.username || 'unknown'}`;
    }

    renderHealthBar(healthRes.services);
    if (selectedAgent) openPanel(selectedAgent);
  } catch(e) { console.error('Fetch error:', e); }
}

function showTokenBreakdown() {
  if (!metrics.tokenUsage || !metrics.costs) {
    fetchAll().then(() => showTokenBreakdown());
    return;
  }

  // Update summary cards
  document.getElementById('total-tokens-today').textContent = metrics.tokenUsage.today.toLocaleString();
  document.getElementById('total-cost-today').textContent = `$${metrics.costs.today.toFixed(2)}`;
  document.getElementById('total-cost-week').textContent = `$${metrics.costs.week.toFixed(2)}`;

  // Update agent breakdown
  const agentGrid = document.getElementById('agent-tokens-grid');
  const sortedAgents = Object.entries(metrics.tokenUsage.perAgent || {})
    .sort((a, b) => b[1] - a[1]); // Sort by token count desc

  agentGrid.innerHTML = sortedAgents.map(([agentName, tokens]) => {
    const cost = (tokens / 1000) * 0.009; // Same rate as server calculation
    const color = COLORS[agentName] || '#94A3B8';
    const icon = ICONS[agentName] || 'ü§ñ';
    const label = LABELS[agentName] || agentName;

    return `
      <div class="agent-token-row">
        <div class="agent-name">
          <span style="font-size:14px">${icon}</span>
          <span style="color:${color};font-weight:600">${label}</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <span class="tokens">${tokens.toLocaleString()}</span>
          <span class="cost">$${cost.toFixed(2)}</span>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('token-breakdown-modal').style.display = 'block';
}

function hideTokenBreakdown() {
  document.getElementById('token-breakdown-modal').style.display = 'none';
}

// Enhanced keyboard shortcuts system
document.addEventListener('keydown', e => {
  // Ignore if typing in input fields
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  // Prevent default behavior for our shortcuts
  const shortcuts = ['1', '2', '3', '4', '5', '6', 'r', 'R', 't', 'T', 'g', 'G', '?', 'Escape'];
  if (shortcuts.includes(e.key)) {
    e.preventDefault();
  }

  switch(e.key) {
    // Agent navigation shortcuts (1-6)
    case '1':
      navigateToAgent('ceo');
      break;
    case '2':
      navigateToAgent('engineering');
      break;
    case '3':
      navigateToAgent('content');
      break;
    case '4':
      navigateToAgent('comms');
      break;
    case '5':
      navigateToAgent('research');
      break;
    case '6':
      navigateToAgent('qa');
      break;

    // System controls
    case 'r':
    case 'R':
      refreshDashboard();
      break;

    case 't':
    case 'T':
      toggleTokenBreakdown();
      break;

    case 'g':
    case 'G':
      toggleGitHubBreakdown();
      break;

    case 'Escape':
      // Dismiss alert first if visible, then close other overlays
      if (currentAlert) {
        dismissAlert();
      } else {
        closeAllOverlays();
      }
      break;

    // Help
    case '?':
      showHelp();
      break;
  }
});

// Agent navigation with visual feedback
function navigateToAgent(agentName) {
  // Close any existing panels first
  closePanel();

  // Add visual feedback to the agent node
  highlightAgent(agentName);

  // Small delay for visual feedback before opening panel
  setTimeout(() => {
    openPanel(agentName);
  }, 150);
}

// Visual highlight for agent navigation
function highlightAgent(agentName) {
  const nodes = getNodes();
  const node = nodes.find(n => n.name === agentName);
  if (!node) return;

  // Create a temporary highlight element
  const highlight = document.createElement('div');
  highlight.style.cssText = `
    position: absolute;
    left: ${node.x - node.r - 8}px;
    top: ${node.y - node.r - 8}px;
    width: ${(node.r + 8) * 2}px;
    height: ${(node.r + 8) * 2}px;
    border: 2px solid ${COLORS[agentName]};
    border-radius: 50%;
    pointer-events: none;
    z-index: 15;
    animation: agentPulse 0.6s ease-out forwards;
  `;

  canvas.parentElement.appendChild(highlight);

  // Remove highlight after animation
  setTimeout(() => {
    if (highlight.parentElement) {
      highlight.parentElement.removeChild(highlight);
    }
  }, 600);
}

// Refresh dashboard with visual feedback
function refreshDashboard() {
  // Add loading state to clock
  const clock = document.getElementById('clock');
  const originalText = clock.textContent;
  clock.style.color = 'var(--accent)';
  clock.textContent = 'REFRESHING...';

  // Force fetch all data
  fetchAll().then(() => {
    // Reset clock after a brief delay
    setTimeout(() => {
      clock.style.color = 'var(--text3)';
      clock.textContent = originalText;
      updateClock(); // Ensure it's current
    }, 500);
  });
}

// Toggle functions for modals
function toggleTokenBreakdown() {
  if (document.getElementById('token-breakdown-modal').style.display === 'block') {
    hideTokenBreakdown();
  } else {
    showTokenBreakdown();
  }
}

function toggleGitHubBreakdown() {
  if (document.getElementById('github-breakdown-modal').style.display === 'block') {
    hideGitHubBreakdown();
  } else {
    showGitHubBreakdown();
  }
}

// Close all overlays and panels
function closeAllOverlays() {
  hideTokenBreakdown();
  hideGitHubBreakdown();
  hideHelp();
  closePanel();
  if (currentAlert) {
    dismissAlert();
  }
}

// Help overlay functions
function showHelp() {
  document.getElementById('help-overlay').classList.add('open');
}

function hideHelp() {
  document.getElementById('help-overlay').classList.remove('open');
}

function showGitHubBreakdown() {
  if (!github || !github.recentCommits) {
    fetchAll().then(() => showGitHubBreakdown());
    return;
  }

  // Update summary cards
  document.getElementById('pushes-today-count').textContent = github.pushesToday || 0;
  document.getElementById('active-repos-count').textContent = github.activeRepos ? github.activeRepos.length : 0;
  document.getElementById('total-repos-count').textContent = github.totalRepos || 0;

  // Update commits list
  const commitsList = document.getElementById('github-commits-list');
  if (github.recentCommits && github.recentCommits.length > 0) {
    commitsList.innerHTML = github.recentCommits.map(commit => {
      const date = new Date(commit.date);
      const timeAgo = getTimeAgo(date);
      const shortMessage = commit.message.length > 80 ? commit.message.substring(0, 77) + '...' : commit.message;

      return `
        <div class="commit-item">
          <div class="commit-header">
            <span class="commit-sha">${commit.sha}</span>
            <span class="commit-repo">${commit.repo}</span>
          </div>
          <div class="commit-message">${shortMessage}</div>
          <div class="commit-date">${timeAgo} ‚Ä¢ ${date.toLocaleDateString()}</div>
        </div>
      `;
    }).join('');
  } else {
    commitsList.innerHTML = '<div style="text-align:center;color:var(--text3);padding:40px">No recent commits found</div>';
  }

  document.getElementById('github-breakdown-modal').style.display = 'block';
}

function hideGitHubBreakdown() {
  document.getElementById('github-breakdown-modal').style.display = 'none';
}

function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffHours < 1) return 'Just now';
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays === 1) return '1 day ago';
  if (diffDays < 7) return `${diffDays} days ago`;
  return date.toLocaleDateString();
}

// Alert Banner System
let currentAlert = null;
let alertTimeout = null;
let dismissedAlerts = new Set(); // Track dismissed alerts to avoid re-showing

function showAlert(severity, message, icon = null, autoDismiss = true) {
  const alertId = `${severity}-${message.substring(0, 50)}`;

  // Don't show if already dismissed
  if (dismissedAlerts.has(alertId)) return;

  const banner = document.getElementById('alert-banner');
  const iconElement = document.getElementById('alert-icon');
  const messageElement = document.getElementById('alert-message');

  // Clear existing timeout
  if (alertTimeout) {
    clearTimeout(alertTimeout);
    alertTimeout = null;
  }

  // Set alert content
  iconElement.textContent = icon || getSeverityIcon(severity);
  messageElement.textContent = message;

  // Apply severity styling
  banner.className = `show ${severity}`;
  document.body.classList.add('alert-active');

  // Store current alert
  currentAlert = { severity, message, icon, alertId };

  // Auto-dismiss for warnings (not for critical/error)
  if (autoDismiss && severity === 'warning') {
    alertTimeout = setTimeout(() => {
      dismissAlert(false); // Don't mark as dismissed permanently for auto-dismiss
    }, 8000);
  }
}

function getSeverityIcon(severity) {
  switch (severity) {
    case 'critical': return 'üî¥';
    case 'error': return '‚ùå';
    case 'warning': return '‚ö†Ô∏è';
    default: return '‚ÑπÔ∏è';
  }
}

function dismissAlert(permanent = true) {
  const banner = document.getElementById('alert-banner');
  document.body.classList.remove('alert-active');
  banner.classList.remove('show');

  if (currentAlert && permanent) {
    dismissedAlerts.add(currentAlert.alertId);
  }

  if (alertTimeout) {
    clearTimeout(alertTimeout);
    alertTimeout = null;
  }

  currentAlert = null;
}

// Alert Detection Logic
function detectSystemAlerts() {
  const alerts = [];

  // Check for service failures
  if (health.services && health.summary) {
    const failedServices = health.services.filter(s => s.status === 'stopped' || s.status === 'errored');
    if (failedServices.length > 0) {
      const serviceNames = failedServices.map(s => s.name).join(', ');
      alerts.push({
        severity: 'critical',
        message: `Service failure detected: ${serviceNames} (${failedServices.length} services down)`,
        icon: 'üî¥'
      });
    }

    // Check for high memory usage
    const highMemoryServices = health.services.filter(s => s.memory > 1000); // >1GB
    if (highMemoryServices.length > 0) {
      const serviceName = highMemoryServices[0].name;
      alerts.push({
        severity: 'warning',
        message: `High memory usage: ${serviceName} using ${highMemoryServices[0].memory}MB`,
        icon: 'üìà'
      });
    }
  }

  // Check for agent failures (no activity for extended period)
  if (agents && agents.length > 0) {
    const inactiveAgents = agents.filter(a => a.status === 'idle' && a.feed.length === 0);
    if (inactiveAgents.length > 2) {
      alerts.push({
        severity: 'warning',
        message: `${inactiveAgents.length} agents are inactive (no recent activity)`,
        icon: 'üò¥'
      });
    }

    // Check for high inbox backlog
    const backloggedAgents = agents.filter(a => a.inbox && a.inbox.pending > 20);
    if (backloggedAgents.length > 0) {
      const agentName = backloggedAgents[0].displayName;
      const pending = backloggedAgents[0].inbox.pending;
      alerts.push({
        severity: 'error',
        message: `High inbox backlog: ${agentName} has ${pending} pending items`,
        icon: 'üìß'
      });
    }
  }

  // Check for GitHub/API errors
  if (github && github.error) {
    alerts.push({
      severity: 'warning',
      message: `GitHub integration error: ${github.error}`,
      icon: 'üì°'
    });
  }

  // Check for excessive token usage
  if (metrics && metrics.costs && metrics.costs.today > 50) { // >$50/day threshold
    alerts.push({
      severity: 'warning',
      message: `High token usage today: $${metrics.costs.today.toFixed(2)} (review agent activity)`,
      icon: 'üí∞'
    });
  }

  // Show highest priority alert
  if (alerts.length > 0) {
    // Sort by severity: critical > error > warning
    const severityOrder = { critical: 3, error: 2, warning: 1 };
    alerts.sort((a, b) => severityOrder[b.severity] - severityOrder[a.severity]);

    const alert = alerts[0];
    showAlert(alert.severity, alert.message, alert.icon);
  }
}

// Integrate alert detection into existing fetch cycle
const originalFetchAll = fetchAll;
fetchAll = async function() {
  await originalFetchAll();

  // Run alert detection after data is updated
  setTimeout(() => {
    detectSystemAlerts();
  }, 100);
};

fetchAll();
setInterval(fetchAll, 30000);
draw();
</script>
</body>
</html>
